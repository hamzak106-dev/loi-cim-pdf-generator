{% extends "base.html" %}

{% block title %}Admin Dashboard - Business Acquisition Services{% endblock %}

{% block content %}
<style>
  .table-container {
    max-height: 600px;
    overflow-y: auto;
    border: 1px solid rgba(255, 255, 255, 0.2);
    border-radius: 8px;
  }
  
  .table {
    color: #fff;
  }
  
  .table thead {
    position: sticky;
    top: 0;
    background-color: rgba(20,34,59, 0.8);
    z-index: 10;
  }
  
  .table tbody tr {
    background-color: rgba(255, 255, 255, 0.05);
  }
  
  .table tbody tr:hover {
    background-color: rgba(13, 56, 114, 0.3);
    cursor: pointer;
    color: #fff;
  }
  
  .table td, .table th {
    border-color: rgba(255, 255, 255, 0.1);
    padding: 12px;
    vertical-align: middle;
  }
  
  .badge {
    padding: 6px 12px;
    font-size: 0.85rem;
  }
  
  .search-box, .filter-select {
    background-color: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.2);
    color: #fff;
  }
  
  .search-box:focus, .filter-select:focus {
    background-color: rgba(255, 255, 255, 0.15);
    border-color: rgba(13, 56, 114, 0.8);
    color: #fff;
  }
  
  .filter-select option {
    background-color: rgba(5, 13, 30, 0.95);
    color: #fff;
  }
  
  .clickable-link {
    color: #4da3ff;
    text-decoration: none;
  }
  
  .clickable-link:hover {
    color: #fff;
    background-color: rgba(13, 56, 114, 0.5);
    padding: 2px 6px;
    border-radius: 4px;
  }
  
  .filter-btn {
    margin: 0 5px;
    border: 1px solid rgba(255, 255, 255, 0.2);
  }
  
  .filter-btn.active {
    background-color: rgba(13, 56, 114, 0.8);
    border: 1px solid #fff;
    color: #fff;
  }
  .badge-loi{
    background-color: rgba(68, 124, 197, 0.8);
 
  }
  .badge-cim{
    background-color: rgba(18, 84, 172, 0.6);
 
  }
  .table-container {
  overflow-y: scroll;
  scrollbar-width: none; 
  scroll-behavior: smooth;
  
  -ms-overflow-style: none; 
}

.table-container::-webkit-scrollbar {
  display: none;
}

/* Keep Super Password input styling constant on focus/active */
#super-pass-value,
#super-pass-value:hover,
#super-pass-value:focus,
#super-pass-value:active {
  background-color: rgba(255, 255, 255, 0.1) !important;
  color: #fff !important;
  border: 1px solid rgba(255, 255, 255, 0.2) !important;
  box-shadow: none !important;
  outline: none !important;
}
</style>

<div class="container-fluid py-4">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <h2>Admin Dashboard</h2>
        <div>
          <span class="text-muted me-3">Welcome, {{ admin_name }}</span>
          <!-- <div class="btn-group me-2">
            <button type="button" class="btn btn-primary dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="bi bi-calendar-event"></i> Meeting Scheduler
            </button>
            <ul class="dropdown-menu">
              <li>
                <a class="dropdown-item" href="#" onclick="scheduleMeeting('LOI Call', 'Evan'); return false;">
                  LOI Call (Host: Evan)
                </a>
              </li>
              <li>
                <a class="dropdown-item" href="#" onclick="scheduleMeeting('CIM Call', null); return false;">
                  CIM Call
                </a>
              </li>
            </ul>
          </div> -->
          <a href="/admin/logout" class="btn btn-outline-light">Logout</a>
        </div>
      </div>
    </div>
  </div>
  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-md-2">
      <div class="card">
        <div class="card-body text-center">
          <h3 class="mb-0">{{ loi_count }}</h3>
          <p class="text-muted mb-0">LOI Review</p>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card">
        <div class="card-body text-center">
          <h3 class="mb-0">{{ cim_count }}</h3>
          <p class="text-muted mb-0">CIM Review</p>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card">
        <div class="card-body text-center">
          <h3 class="mb-0">{{ cim_training_count }}</h3>
          <p class="text-muted mb-0">CIM Training</p>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card">
        <div class="card-body text-center">
          <h3 class="mb-0">{{ total_count }}</h3>
          <p class="text-muted mb-0">Total Active</p>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card">
        <div class="card-body text-center">
          <h3 class="mb-0">{{ reviewed_count }}</h3>
          <p class="text-muted mb-0">Reviewed</p>
        </div>
      </div>
    </div>
    <div class="col-md-2">
      <div class="card">
        <div class="card-body text-center">
          <h3 class="mb-0">{{ user_count }}</h3>
          <p class="text-muted mb-0">Total Users</p>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Generate/Update Password Section -->
  <!--<div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0"><i class="bi bi-key"></i> Generate / Update User Password</h4>
        </div>
        <div class="card-body">
          <form id="generate-credentials-form" onsubmit="generateOrUpdateCredentials(event)">
            <div class="row">
              <div class="col-md-4">
                <label for="user-email" class="form-label">Email Address <span class="text-danger">*</span></label>
                <input 
                  type="email" 
                  class="form-control" 
                  id="user-email" 
                  name="email" 
                  required
                  placeholder="user@example.com"
                >
              </div>
              <div class="col-md-4">
                <label for="user-name" class="form-label">Name (Optional)</label>
                <input 
                  type="text" 
                  class="form-control" 
                  id="user-name" 
                  name="name"
                  placeholder="User's full name"
                >
              </div>
              <div class="col-md-4 d-flex align-items-end">
                <button type="submit" class="btn btn-primary w-100" id="invite-btn">
                  <i class="bi bi-shield-lock"></i> Generate / Update Password
                </button>
              </div>
            </div>
          </form>
          <div id="invite-message" class="mt-3"></div>
        </div>
      </div>
    </div>
  </div>-->
  
  <!-- Super Password Section -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h4 class="mb-0"><i class="bi bi-shield-lock"></i> Super Password</h4>
          <small class="text-muted">Allows login without email</small>
        </div>
        <div class="card-body">
          <div class="d-flex flex-wrap gap-3 align-items-center">
            <button id="super-pass-btn" class="btn btn-outline-warning" onclick="confirmSuperPasswordChange()">
              <i class="bi bi-key"></i> Generate Password
            </button>
            <div class="d-flex align-items-center" style="min-width: 340px;">
              <label class="me-2 mb-0 text-muted">Password:</label>
              <div class="input-group">
                <input type="text" class="form-control" id="super-pass-value" value="" placeholder="Not set / not available" readonly>
                <button class="btn btn-outline-light" onclick="copyCurrentSuperPassword(event)"><i class="bi bi-clipboard"></i></button>
              </div>
            </div>
            <!-- <span id="super-pass-status" class="text-muted"></span> -->
          </div>
          <div class="form-text mt-2">Generate a single password that any user can use to log in without an email.</div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Users List Section -->
  <!-- <div class="row mb-4">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <div class="d-flex justify-content-between align-items-center">
            <h4 class="mb-0"><i class="bi bi-people"></i> Invited Users</h4>
            <span class="text-muted">Total: {{ user_total }}</span>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-container">
            <table class="table table-hover mb-0" id="users-table">
              <thead>
                <tr>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Status</th>
                  <th>Created At</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for user in users %}
                <tr>
                  <td><strong>{{ user.name }}</strong></td>
                  <td>{{ user.email }}</td>
                  <td>
                    {% if user.is_active %}
                      <span class="badge bg-success">Active</span>
                    {% else %}
                      <span class="badge bg-secondary">Inactive</span>
                    {% endif %} 
                  </td>
                  <td>
                    {% if user.created_at %}
                      {{ user.created_at.strftime('%Y-%m-%d %H:%M') }}
                    {% else %}
                      --
                    {% endif %}
                  </td>
                  <td>
                    <button 
                      class="btn btn-sm btn-info me-2" 
                      onclick="resendUserCredentials({{ user.id }}, '{{ user.email }}', '{{ user.name }}')"
                      title="Resend Credentials"
                    >
                      <i class="bi bi-envelope-paper"></i> Resend Credentials
                    </button>
                    <button 
                      class="btn btn-sm btn-danger" 
                      onclick="deleteUser({{ user.id }}, '{{ user.email }}')"
                      title="Delete User"
                    >
                      <i class="bi bi-trash"></i> Delete
                    </button>
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="5" class="text-center text-muted">No users invited yet</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          
          {% if user_total_pages > 1 %}
          <div class="card-footer">
            <nav aria-label="Users pagination">
              <ul class="pagination justify-content-center mb-0">
                {% if user_page > 1 %}
                <li class="page-item">
                  <a class="page-link" href="?user_page={{ user_page - 1 }}{% if current_filter != 'all' %}&filter_type={{ current_filter }}{% endif %}">Previous</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                  <span class="page-link">Previous</span>
                </li>
                {% endif %}
                
                {% if user_total_pages <= 7 %}
                  {# Show all pages if 7 or fewer #}
                  {% for page_num in range(1, user_total_pages + 1) %}
                    {% if page_num == user_page %}
                    <li class="page-item active">
                      <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% else %}
                    <li class="page-item">
                      <a class="page-link" href="?user_page={{ page_num }}{% if current_filter != 'all' %}&filter_type={{ current_filter }}{% endif %}">{{ page_num }}</a>
                    </li>
                    {% endif %}
                  {% endfor %}
                {% else %}
                  {# Show first, last, current, and pages around current #}
                  {% set start_page = user_page - 1 if user_page > 1 else 1 %}
                  {% set end_page = user_page + 1 if user_page < user_total_pages else user_total_pages %}
                  
                  {% if user_page > 1 %}
                  <li class="page-item">
                    <a class="page-link" href="?user_page=1{% if current_filter != 'all' %}&filter_type={{ current_filter }}{% endif %}">1</a>
                  </li>
                  {% if user_page > 3 %}
                  <li class="page-item disabled">
                    <span class="page-link">...</span>
                  </li>
                  {% endif %}
                  {% endif %}
                  
                  {% for page_num in range(start_page, end_page + 1) %}
                    {% if page_num == user_page %}
                    <li class="page-item active">
                      <span class="page-link">{{ page_num }}</span>
                    </li>
                    {% else %}
                    <li class="page-item">
                      <a class="page-link" href="?user_page={{ page_num }}{% if current_filter != 'all' %}&filter_type={{ current_filter }}{% endif %}">{{ page_num }}</a>
                    </li>
                    {% endif %}
                  {% endfor %}
                  
                  {% if user_page < user_total_pages %}
                  {% if user_page < user_total_pages - 2 %}
                  <li class="page-item disabled">
                    <span class="page-link">...</span>
                  </li>
                  {% endif %}
                  <li class="page-item">
                    <a class="page-link" href="?user_page={{ user_total_pages }}{% if current_filter != 'all' %}&filter_type={{ current_filter }}{% endif %}">{{ user_total_pages }}</a>
                  </li>
                  {% endif %}
                {% endif %}
                
                {% if user_page < user_total_pages %}
                <li class="page-item">
                  <a class="page-link" href="?user_page={{ user_page + 1 }}{% if current_filter != 'all' %}&filter_type={{ current_filter }}{% endif %}">Next</a>
                </li>
                {% else %}
                <li class="page-item disabled">
                  <span class="page-link">Next</span>
                </li>
                {% endif %}
              </ul>
            </nav>
            <div class="text-center mt-2">
              <small class="text-muted">
                Showing {{ ((user_page - 1) * 5) + 1 }} to 
                {% if user_page * 5 > user_total %}{{ user_total }}{% else %}{{ user_page * 5 }}{% endif %} 
                of {{ user_total }} users
              </small>
            </div>
          </div>
          {% endif %}
        </div>
      </div>
    </div>
  </div> -->
  
  <!-- Unified Forms Table -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <div class="row align-items-center">
            <div class="col-md-4">
              <h4 class="mb-0">All Submissions</h4>
            </div>
            <div class="col-md-8">
              <div class="d-flex justify-content-end align-items-center gap-2">
                <!-- Filter Buttons -->
                <div class="btn-group" role="group">
                  <a href="/admin/dashboard?filter_type=all" class="btn btn-sm btn-outline-light filter-btn {% if current_filter == 'all' %}active{% endif %}">All</a>
                  <a href="/admin/dashboard?filter_type=loi" class="btn btn-sm btn-outline-light filter-btn {% if current_filter == 'loi' %}active{% endif %}">LOI Review</a>
                  <a href="/admin/dashboard?filter_type=cim_ben" class="btn btn-sm btn-outline-light filter-btn {% if current_filter == 'cim_ben' %}active{% endif %}">CIM Review (Ben)</a>
                  <a href="/admin/dashboard?filter_type=cim_mitch" class="btn btn-sm btn-outline-light filter-btn {% if current_filter == 'cim_mitch' %}active{% endif %}">CIM Review (Mitch)</a>
                  <a href="/admin/dashboard?filter_type=cim_training" class="btn btn-sm btn-outline-light filter-btn {% if current_filter == 'cim_training' %}active{% endif %}">CIM Training</a>
                  <!-- Date filter (commented out for now)
                  <a href="/admin/dashboard?filter_type=with_meeting_date" class="btn btn-sm btn-outline-light filter-btn {% if current_filter == 'with_meeting_date' %}active{% endif %}">With meeting date</a>
                  <a href="/admin/dashboard?filter_type=no_meeting_date" class="btn btn-sm btn-outline-light filter-btn {% if current_filter == 'no_meeting_date' %}active{% endif %}">No meeting date</a>
                </div>
                <div class="ms-2 d-inline-flex align-items-center gap-1">
                  <button type="button" class="btn btn-sm btn-outline-light" id="custom-date-btn" title="Filter by meeting date">
                    <i class="bi bi-calendar3"></i> Custom date
                  </button>
                  <input type="date" id="custom-date-input" class="form-control form-control-sm d-none" style="max-width: 140px;" data-base-url="/admin/dashboard">
                  {% if current_meeting_date %}
                  <a href="/admin/dashboard?filter_type={{ current_filter }}" class="btn btn-sm btn-outline-secondary" title="Clear date filter">{{ current_meeting_date }} &times;</a>
                  {% endif %}
                </div>
                <script>
                (function() {
                  var baseUrl = '/admin/dashboard';
                  var filterType = '{{ current_filter }}';
                  var btn = document.getElementById('custom-date-btn');
                  var input = document.getElementById('custom-date-input');
                  if (btn && input) {
                    btn.addEventListener('click', function() {
                      input.classList.toggle('d-none');
                      if (!input.classList.contains('d-none')) {
                        input.focus();
                        try { input.showPicker && input.showPicker(); } catch (e) {}
                      }
                    });
                    input.addEventListener('change', function() {
                      var v = this.value;
                      if (!v) return;
                      var parts = v.split('-');
                      if (parts.length !== 3) return;
                      var months = ['Jan','Feb','Mar','Apr','May','Jun','Jul','Aug','Sep','Oct','Nov','Dec'];
                      var formatted = months[parseInt(parts[1],10)-1] + ' ' + parts[2] + ', ' + parts[0];
                      window.location.href = baseUrl + '?filter_type=' + encodeURIComponent(filterType) + '&meeting_date=' + encodeURIComponent(formatted);
                    });
                  }
                })();
                </script>
                -->
                </div>
                <!-- Search Box -->
                <input 
                  type="text" 
                  id="search-input" 
                  class="form-control search-box" 
                  placeholder="Search by name or email..." 
                  style="max-width: 300px;"
                  onkeyup="filterTable()"
                >
              </div>
            </div>
          </div>
        </div>
        <div class="card-body p-0">
          <div class="table-container">
            <table class="table table-hover mb-0" id="forms-table">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Date of meeting</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>PDF URL</th>
                  <th>File URL</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for form in forms %}
                <tr onclick="window.location.href='/admin/record/{{ form.id }}'">
                  <td>
                    {% if form.form_type.value == 'LOI' %}
                      <span class="badge badge-loi">LOI</span>
                    {% elif form.form_type.value == 'CIM_TRAINING' %}
                      <span class="badge badge-cim">CIM Training</span>
                    {% else %}
                      <span class="badge badge-cim">CIM</span>
                    {% endif %}
                  </td>
                  <td>{{ form.meeting_date_display }}</td>
                  <td><strong>{{ form.full_name }}</strong></td>
                    <td>{{ form.email }}</td>
                  <td onclick="event.stopPropagation()">
                    {% if form.file_urls %}
                      <a href="{{ form.file_urls }}" target="_blank" class="clickable-link">View PDF</a>
                    {% else %}
                      <span class="text-muted">--</span>
                    {% endif %}
                  </td>
                  <td onclick="event.stopPropagation()">
                    {% if form.uploaded_file_url %}
                      <a href="{{ form.uploaded_file_url }}" target="_blank" class="clickable-link">View File</a>
                    {% else %}
                      <span class="text-muted">--</span>
                    {% endif %}
                  </td>
                  <td onclick="event.stopPropagation()">
                    <div class="btn-group">
                      <button type="button" class="btn btn-sm btn-outline-light dropdown-toggle" data-bs-toggle="dropdown" aria-expanded="false" onclick="event.stopPropagation()">
                        Actions
                      </button>
                      <ul class="dropdown-menu dropdown-menu-dark">
                        <li>
                          <form method="POST" action="/admin/mark-reviewed/{{ form.id }}" onclick="event.stopPropagation()" style="display: inline;">
                            <button type="submit" class="dropdown-item text-success">
                              <i class="bi bi-check2-circle"></i> Mark Reviewed
                            </button>
                          </form>
                        </li>
                        <!-- You can add more actions here if needed -->
                      </ul>
                    </div>
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="7" class="text-center text-muted">No submissions yet</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Reviewed Forms Table -->
  <div class="row mb-5">
    <div class="col-12">
      <div class="card">
        <div class="card-header">
          <h4 class="mb-0">Reviewed Forms</h4>
        </div>
        <div class="card-body p-0">
          <div class="table-container">
            <table class="table table-hover mb-0" id="reviewed-forms-table">
              <thead>
                <tr>
                  <th>Type</th>
                  <th>Name</th>
                  <th>Email</th>
                  <th>Date of meeting</th>
                  <th>PDF URL</th>
                  <th>File URL</th>
                  <th>Action</th>
                </tr>
              </thead>
              <tbody>
                {% for form in reviewed_forms %}
                <tr onclick="window.location.href='/admin/record/{{ form.id }}'">
                  <td>
                    {% if form.form_type.value == 'LOI' %}
                      <span class="badge badge-loi">LOI</span>
                    {% elif form.form_type.value == 'CIM_TRAINING' %}
                      <span class="badge badge-cim">CIM Training</span>
                    {% else %}
                      <span class="badge badge-cim">CIM</span>
                    {% endif %}
                  </td>
                  <td><strong>{{ form.full_name }}</strong></td>
                  <td>{{ form.email }}</td>
                  <td>{{ form.meeting_date_display }}</td>
                  <td onclick="event.stopPropagation()">
                    {% if form.file_urls %}
                      <a href="{{ form.file_urls }}" target="_blank" class="clickable-link">View PDF</a>
                    {% else %}
                      <span class="text-muted">--</span>
                    {% endif %}
                  </td>
                  <td onclick="event.stopPropagation()">
                    {% if form.uploaded_file_url %}
                      <a href="{{ form.uploaded_file_url }}" target="_blank" class="clickable-link">View File</a>
                    {% else %}
                      <span class="text-muted">--</span>
                    {% endif %}
                  </td>
                  <td onclick="event.stopPropagation()">
                    <form method="POST" action="/admin/mark-unreviewed/{{ form.id }}" style="display: inline;">
                      <button type="submit" class="btn btn-sm btn-outline-warning">
                        <i class="bi bi-arrow-counterclockwise"></i> Unreview
                      </button>
                    </form>
                  </td>
                </tr>
                {% else %}
                <tr>
                  <td colspan="7" class="text-center text-muted">No reviewed forms yet</td>
                </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
// Prevent showing cached admin dashboard via back/forward navigation after logout
window.addEventListener('pageshow', function (event) {
  // If the page was restored from the BFCache, force a reload
  if (event.persisted) {
    window.location.reload();
  }
});

function scheduleMeeting(formType, host) {
  if (formType === 'CIM Call' && !host) {
    // Show host selection modal for CIM Call
    showHostSelectionModal(formType);
  } else {
    // Redirect directly to Google Calendar
    redirectToGoogleCalendar(formType, host);
  }
}

function showHostSelectionModal(formType) {
  // Create a simple modal for host selection
  const modal = `
    <div class="modal fade" id="hostSelectionModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content" style="background-color: rgba(5, 13, 30, 0.95); color: #fff;">
          <div class="modal-header">
            <h5 class="modal-title">Select Host for CIM Call</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="d-grid gap-2">
              <button class="btn btn-primary" onclick="selectHost('Ben')">Ben</button>
              <button class="btn btn-primary" onclick="selectHost('Mitch')">Mitch</button>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal if any
  const existing = document.getElementById('hostSelectionModal');
  if (existing) existing.remove();
  
  // Add modal to body
  document.body.insertAdjacentHTML('beforeend', modal);
  
  // Show modal
  const modalElement = new bootstrap.Modal(document.getElementById('hostSelectionModal'));
  modalElement.show();
  
  // Store form type globally
  window.selectedFormType = formType;
}

function selectHost(host) {
  const formType = window.selectedFormType || 'CIM Call';
  bootstrap.Modal.getInstance(document.getElementById('hostSelectionModal')).hide();
  redirectToGoogleCalendar(formType, host);
}

function redirectToGoogleCalendar(formType, host) {
  // Build event title
  const title = host ? `${formType} - ${host}` : formType;
  
  // Encode title for URL
  const encodedTitle = encodeURIComponent(title);
  
  // Redirect directly to Google Calendar event creation
  const calendarUrl = `https://calendar.google.com/calendar/render?action=TEMPLATE&text=${encodedTitle}`;
  
  // Open in the same window
  window.location.href = calendarUrl;
}

function filterTable() {
  const input = document.getElementById('search-input');
  const filter = input.value.toUpperCase();
  const table = document.getElementById('forms-table');
  const tr = table.getElementsByTagName('tr');
  
  for (let i = 1; i < tr.length; i++) {
    const nameCell = tr[i].getElementsByTagName('td')[1]; // Name column
    const emailCell = tr[i].getElementsByTagName('td')[2]; // Email column
    
    if (nameCell && emailCell) {
      const nameText = nameCell.textContent || nameCell.innerText;
      const emailText = emailCell.textContent || emailCell.innerText;
      
      if (nameText.toUpperCase().indexOf(filter) > -1 || emailText.toUpperCase().indexOf(filter) > -1) {
        tr[i].style.display = '';
      } else {
        tr[i].style.display = 'none';
      }
    }
  }
}

async function generateOrUpdateCredentials(event) {
  event.preventDefault();
  
  const form = event.target;
  const formData = new FormData(form);
  const inviteBtn = document.getElementById('invite-btn');
  const messageDiv = document.getElementById('invite-message');
  
  // Disable button and show loading
  inviteBtn.disabled = true;
  inviteBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Processing...';
  messageDiv.innerHTML = '';
  
  try {
    const response = await fetch('/admin/generate-credentials', {
      method: 'POST',
      body: formData
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Show credentials modal
      showCredentialsModal(data.credentials, data.email_sent, Boolean(data.password_reset), data.message || null);
      
      // Reset form
      form.reset();
      
      // Show success message
      messageDiv.innerHTML = '<div class="alert alert-success">Credentials generated successfully!</div>';
      
      // Reload page after 2 seconds to update user count
      setTimeout(() => {
        window.location.reload();
      }, 2000);
    } else {
      messageDiv.innerHTML = `<div class="alert alert-danger">${data.error || 'Failed to generate credentials'}</div>`;
    }
  } catch (error) {
    messageDiv.innerHTML = `<div class="alert alert-danger">Error: ${error.message}</div>`;
  } finally {
    inviteBtn.disabled = false;
    inviteBtn.innerHTML = '<i class="bi bi-shield-lock"></i> Generate / Update Password';
  }
}

function showCredentialsModal(credentials, emailSent, passwordReset, message) {
  let alertMessage = '';
  if (passwordReset) {
    alertMessage = `<div class="alert alert-warning">
      <i class="bi bi-exclamation-triangle"></i> 
      <strong>Password Reset:</strong> ${message || 'Password has been reset. New credentials are shown below.'}
    </div>`;
  } else if (emailSent) {
    alertMessage = `<div class="alert alert-info">
      <i class="bi bi-info-circle"></i> 
      Credentials have been sent to the user's email.
    </div>`;
  } else {
    alertMessage = `<div class="alert alert-info">
      <i class="bi bi-info-circle"></i> 
      Note: Email could not be sent, but credentials are shown below.
    </div>`;
  }
  
  const modal = `
    <div class="modal fade" id="credentialsModal" tabindex="-1" data-bs-backdrop="static">
      <div class="modal-dialog">
        <div class="modal-content" style="background-color: rgba(5, 13, 30, 0.95); color: #fff;">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-key"></i> User Credentials</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            ${alertMessage}
            <div class="mb-3">
              <label class="form-label fw-bold">Email:</label>
              <div class="input-group">
                <input type="text" class="form-control" id="cred-email" value="${credentials.email}" readonly>
                <button class="btn btn-outline-light" onclick="copyToClipboard(event, '${credentials.email}')">
                  <i class="bi bi-clipboard"></i> Copy
                </button>
              </div>
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Password:</label>
              <div class="input-group">
                <input type="text" class="form-control" id="cred-password" value="${credentials.password}" readonly>
                <button class="btn btn-outline-light" onclick="copyToClipboard(event, '${credentials.password}')">
                  <i class="bi bi-clipboard"></i> Copy
                </button>
              </div>
            </div>
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle"></i> 
              <strong>Important:</strong> Please save these credentials. The password cannot be retrieved later.
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal if any
  const existing = document.getElementById('credentialsModal');
  if (existing) existing.remove();
  
  // Add modal to body
  document.body.insertAdjacentHTML('beforeend', modal);
  
  // Show modal
  const modalElement = new bootstrap.Modal(document.getElementById('credentialsModal'));
  modalElement.show();
}

function copyToClipboard(evt, text) {
  const showFeedback = (buttonEl) => {
    if (!buttonEl) return;
    const originalHTML = buttonEl.innerHTML;
    buttonEl.innerHTML = '<i class="bi bi-check"></i> Copied!';
    buttonEl.classList.add('btn-success');
    buttonEl.classList.remove('btn-outline-light');
    setTimeout(() => {
      buttonEl.innerHTML = originalHTML;
      buttonEl.classList.remove('btn-success');
      buttonEl.classList.add('btn-outline-light');
    }, 2000);
  };

  const button = evt && evt.target ? evt.target.closest('button') : null;

  const tryNativeClipboard = () => {
    if (navigator.clipboard && window.isSecureContext) {
      return navigator.clipboard.writeText(text);
    }
    return Promise.reject(new Error('Clipboard API not available or insecure context'));
  };

  const fallbackCopy = () => {
    try {
      const textarea = document.createElement('textarea');
      textarea.value = text;
      textarea.setAttribute('readonly', '');
      textarea.style.position = 'absolute';
      textarea.style.left = '-9999px';
      document.body.appendChild(textarea);
      textarea.select();
      const successful = document.execCommand('copy');
      document.body.removeChild(textarea);
      return successful ? Promise.resolve() : Promise.reject(new Error('execCommand copy failed'));
    } catch (e) {
      return Promise.reject(e);
    }
  };

  tryNativeClipboard()
    .catch(() => fallbackCopy())
    .then(() => {
      showFeedback(button);
    })
    .catch(err => {
      console.error('Failed to copy:', err);
      alert('Failed to copy to clipboard');
    });
}

function setSuperPassValue(value) {
  const input = document.getElementById('super-pass-value');
  if (!input) return;
  input.value = value || '';
  if (!value) {
    input.placeholder = 'Not set / not available';
  }
  updateSuperPassButtonLabel();
}

async function fetchCurrentSuperPassword() {
  try {
    const res = await fetch('/admin/super-password/current');
    const data = await res.json();
    if (data.success) {
      setSuperPassValue(data.password || '');
    }
  } catch (e) {
    // ignore
  }
}

function copyCurrentSuperPassword(evt) {
  const val = (document.getElementById('super-pass-value') || {}).value || '';
  if (!val) {
    alert('No super password available to copy. Generate one first.');
    return;
  }
  copyToClipboard(evt, val);
}

function updateSuperPassButtonLabel() {
  const btn = document.getElementById('super-pass-btn');
  const input = document.getElementById('super-pass-value');
  if (!btn || !input) return;
  const hasPassword = Boolean((input.value || '').trim());
  btn.innerHTML = hasPassword 
    ? '<i class="bi bi-key"></i> Update Password' 
    : '<i class="bi bi-key"></i> Generate Password';
}

// ===== Super Password Helpers =====
async function updateSuperPasswordStatus() {
  try {
    const res = await fetch('/admin/super-password/status');
    const data = await res.json();
    const el = document.getElementById('super-pass-status');
    if (!el) return;
    if (data.success) {
      el.textContent = data.is_set ? 'Status: Set' : 'Status: Not set';
    } else {
      el.textContent = 'Status: Unknown';
    }
  } catch (e) {
    const el = document.getElementById('super-pass-status');
    if (el) el.textContent = 'Status: Error';
  }
}

function showSuperPasswordModal(password) {
  const modal = `
    <div class="modal fade" id="superPasswordModal" tabindex="-1" data-bs-backdrop="static">
      <div class="modal-dialog">
        <div class="modal-content" style="background-color: rgba(5, 13, 30, 0.95); color: #fff;">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-shield-lock"></i> Super Password</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="alert alert-warning">
              <i class="bi bi-exclamation-triangle"></i>
              <strong>Important:</strong> Anyone with this password can log in without email. Keep it secure.
            </div>
            <div class="mb-3">
              <label class="form-label fw-bold">Password:</label>
              <div class="input-group">
                <input type="text" class="form-control" id="super-pass-input" value="${password}" readonly>
                <button class="btn btn-outline-light" onclick="copyToClipboard(event, '${password}')">
                  <i class="bi bi-clipboard"></i> Copy
                </button>
              </div>
            </div>
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
          </div>
        </div>
      </div>
    </div>`;
  const existing = document.getElementById('superPasswordModal');
  if (existing) existing.remove();
  document.body.insertAdjacentHTML('beforeend', modal);
  const modalElement = new bootstrap.Modal(document.getElementById('superPasswordModal'));
  modalElement.show();
}

function confirmSuperPasswordChange() {
  const modal = `
    <div class="modal fade" id="confirmSuperPasswordModal" tabindex="-1">
      <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content" style="background-color: rgba(5, 13, 30, 0.95); color: #fff;">
          <div class="modal-header">
            <h5 class="modal-title"><i class="bi bi-question-circle"></i> Confirm Update</h5>
            <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            Are you sure you want to change the super password for everyone in the community?
          </div>
          <div class="modal-footer">
            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">No</button>
            <button type="button" class="btn btn-warning" id="confirm-super-pass-yes">Yes, update</button>
          </div>
        </div>
      </div>
    </div>`;
  const existing = document.getElementById('confirmSuperPasswordModal');
  if (existing) existing.remove();
  document.body.insertAdjacentHTML('beforeend', modal);
  const el = document.getElementById('confirmSuperPasswordModal');
  const modalInstance = new bootstrap.Modal(el);
  el.querySelector('#confirm-super-pass-yes').addEventListener('click', () => {
    modalInstance.hide();
    const btn = document.getElementById('super-pass-btn');
    if (btn) generateSuperPassword(btn);
  });
  modalInstance.show();
}

async function generateSuperPassword(btn) {
  const original = btn.innerHTML;
  btn.disabled = true;
  btn.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Generating...';
  try {
    const res = await fetch('/admin/super-password/generate', { method: 'POST' });
    const data = await res.json();
    if (data.success && data.password) {
      updateSuperPasswordStatus();
      setSuperPassValue(data.password);
      updateSuperPassButtonLabel();
    } else {
      alert(data.error || 'Failed to generate super password');
    }
  } catch (e) {
    alert('Error generating super password: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = original;
  }
}

// Initialize super password status on load
document.addEventListener('DOMContentLoaded', () => {
  updateSuperPasswordStatus();
  fetchCurrentSuperPassword();
  updateSuperPassButtonLabel();
});

async function resendUserCredentials(userId, email, name) {
  try {
    // Resend credentials email (will reset password if not stored)
    const response = await fetch(`/admin/user/${userId}/resend-email`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      }
    });
    
    const data = await response.json();
    
    if (data.success && data.credentials) {
      // Show credentials modal
      showCredentialsModal(
        data.credentials,
        data.email_sent || false,
        data.password_reset || false,
        data.message || 'Credentials have been sent to the user\'s email.'
      );
    } else {
      alert(data.error || data.message || 'Failed to resend credentials.');
    }
  } catch (error) {
    alert('Error resending credentials: ' + error.message);
  }
}

async function deleteUser(userId, email) {
  if (!confirm(`Are you sure you want to delete user "${email}"?\n\nThis action cannot be undone.`)) {
    return;
  }
  
  try {
    const response = await fetch(`/admin/user/${userId}`, {
      method: 'DELETE'
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Show success message
      alert('User deleted successfully!');
      // Reload page to update user list
      window.location.reload();
    } else {
      alert('Error: ' + (data.error || 'Failed to delete user'));
    }
  } catch (error) {
    alert('Error deleting user: ' + error.message);
  }
}
</script>
{% endblock %}
