{% extends "base.html" %}

{% block title %}LOI Questions{% endblock %}

{% block scripts %}
<script>
// Fetch and display calendar events
document.addEventListener('DOMContentLoaded', function() {
  fetchCalendarEvents();
  
  // Enable/disable Schedule Call button based on email input
  const emailInput = document.getElementById('email');
  const scheduleBtn = document.getElementById('scheduleCallBtn');
  
  if (emailInput && scheduleBtn) {
    function updateScheduleButton() {
      const email = emailInput.value.trim();
      const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      
      if (email && emailPattern.test(email)) {
        scheduleBtn.style.opacity = '1';
        scheduleBtn.style.cursor = 'pointer';
        scheduleBtn.style.pointerEvents = 'auto';
        scheduleBtn.parentElement.querySelector('small').style.display = 'none';
      } else {
        scheduleBtn.style.opacity = '0.6';
        scheduleBtn.style.cursor = 'not-allowed';
        scheduleBtn.style.pointerEvents = 'auto'; // Still allow click to show alert
        scheduleBtn.parentElement.querySelector('small').style.display = 'block';
      }
    }
    
    // Check on page load
    updateScheduleButton();
    
    // Check on input change
    emailInput.addEventListener('input', updateScheduleButton);
    emailInput.addEventListener('blur', updateScheduleButton);
  }
});

async function fetchCalendarEvents() {
  const loadingEl = document.getElementById('eventsLoading');
  const errorEl = document.getElementById('eventsError');
  const eventsListEl = document.getElementById('eventsList');
  
  try {
    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    eventsListEl.innerHTML = '';
    
    // Get calendar_id from backend template variable
    const calendarId = '{{ calendar_id }}' || 'primary';
    const response = await fetch(`/api/calendar/events?calendar_id=${encodeURIComponent(calendarId)}`);
    const data = await response.json();
    
    loadingEl.style.display = 'none';
    
    if (!data.success || !data.events || data.events.length === 0) {
      eventsListEl.innerHTML = '<div class="text-muted text-center py-3">No upcoming events found.</div>';
      return;
    }
    
    // Filter future events and sort by start time
    // API returns start/end as ISO datetime strings (e.g., "2025-12-02T19:00:00+05:00")
    const now = new Date();
    const futureEvents = data.events
      .filter(event => {
        // Handle both ISO string format and object format for compatibility
        const startTime = typeof event.start === 'string' ? event.start : (event.start?.dateTime || event.start?.date);
        return startTime && new Date(startTime) >= now;
      })
      .sort((a, b) => {
        const startA = typeof a.start === 'string' ? a.start : (a.start?.dateTime || a.start?.date || 0);
        const startB = typeof b.start === 'string' ? b.start : (b.start?.dateTime || b.start?.date || 0);
        return new Date(startA) - new Date(startB);
      })
      .slice(0, 10); // Show top 10 upcoming events
    
    if (futureEvents.length === 0) {
      eventsListEl.innerHTML = '<div class="text-muted text-center py-3">No upcoming events found.</div>';
      return;
    }
    
    // Display events in detailed list format
    futureEvents.forEach(event => {
      const eventCard = document.createElement('div');
      eventCard.className = 'card mb-3';
      eventCard.style.backgroundColor = 'rgba(255, 255, 255, 0.05)';
      eventCard.style.borderColor = 'rgba(255, 255, 255, 0.1)';
      
      // Parse ISO datetime strings from API response (format: "2025-12-02T19:00:00+05:00")
      const startTimeStr = typeof event.start === 'string' ? event.start : (event.start?.dateTime || event.start?.date || '');
      const endTimeStr = typeof event.end === 'string' ? event.end : (event.end?.dateTime || event.end?.date || '');
      const startDate = startTimeStr ? new Date(startTimeStr) : new Date();
      const endDate = endTimeStr ? new Date(endTimeStr) : new Date();
      
      const formattedDate = startDate.toLocaleDateString('en-US', { 
        weekday: 'long', 
        year: 'numeric', 
        month: 'long', 
        day: 'numeric' 
      });
      const formattedStartTime = startDate.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        timeZoneName: 'short'
      });
      const formattedEndTime = endDate.toLocaleTimeString('en-US', { 
        hour: '2-digit', 
        minute: '2-digit',
        timeZoneName: 'short'
      });
      
      // Format attendees with full details (email, organizer, self, responseStatus)
      let attendeesList = '';
      if (event.attendees && event.attendees.length > 0) {
        attendeesList = event.attendees.map(att => {
          const email = att.email || 'Unknown';
          const isOrganizer = att.organizer ? ' (Organizer)' : '';
          const isSelf = att.self ? ' (You)' : '';
          const status = att.responseStatus ? ` [${att.responseStatus}]` : '';
          return `${email}${isOrganizer}${isSelf}${status}`;
        }).join(', ');
      }
      
      // Format organizer
      const organizer = event.organizer ? (event.organizer.email || event.organizer.displayName || '') : '';
      
      // Format reminders
      const remindersInfo = event.reminders ? 
        (event.reminders.useDefault ? 'Default reminders' : 
         (event.reminders.overrides ? event.reminders.overrides.map(r => `${r.method} ${r.minutes}min before`).join(', ') : 'No reminders'))
        : '';
      
      // Check if recurring
      const isRecurring = event.recurrence && event.recurrence.length > 0;
      
      eventCard.innerHTML = `
        <div class="card-body">
          <h6 class="card-title mb-2">
            ${escapeHtml(event.summary || 'Untitled Event')}
            ${isRecurring ? '<span class="badge bg-info ms-2">Recurring</span>' : ''}
          </h6>
          <div class="mb-2">
            <small class="text-muted">
              <i class="bi bi-calendar-event"></i> ${formattedDate}<br>
              <i class="bi bi-clock"></i> ${formattedStartTime} - ${formattedEndTime}
            </small>
          </div>
          ${event.description ? `<p class="card-text small mb-2">${escapeHtml(event.description)}</p>` : ''}
          ${event.location ? `<p class="card-text small mb-2"><i class="bi bi-geo-alt"></i> ${escapeHtml(event.location)}</p>` : ''}
          ${organizer ? `<p class="card-text small mb-2"><i class="bi bi-person"></i> Organizer: ${escapeHtml(organizer)}</p>` : ''}
          ${remindersInfo ? `<p class="card-text small mb-2"><i class="bi bi-bell"></i> ${escapeHtml(remindersInfo)}</p>` : ''}
          ${event.hangoutLink ? `<a href="${event.hangoutLink}" target="_blank" class="btn btn-sm btn-primary mb-2"><i class="bi bi-camera-video"></i> Join Google Meet</a>` : ''}
          ${attendeesList ? `
            <div class="mt-2">
              <small class="text-muted">
                <i class="bi bi-people"></i> Attendees: ${escapeHtml(attendeesList)}
              </small>
            </div>
          ` : ''}
          ${event.htmlLink ? `<a href="${event.htmlLink}" target="_blank" class="btn btn-sm btn-outline-secondary mt-2"><i class="bi bi-calendar-check"></i> View in Calendar</a>` : ''}
        </div>
      `;
      
      eventsListEl.appendChild(eventCard);
    });
    
  } catch (error) {
    loadingEl.style.display = 'none';
    errorEl.textContent = 'Failed to load events. Please try again later.';
    errorEl.style.display = 'block';
    console.error('Error fetching calendar events:', error);
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Handle Schedule Call button click - check email first
function handleScheduleCall(event) {
  event.preventDefault();
  const emailInput = document.getElementById('email');
  const email = emailInput ? emailInput.value.trim() : '';
  
  if (!email) {
    alert('Please enter your email address first');
    emailInput.focus();
    return false;
  }
  
  // Validate email format
  const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
  if (!emailPattern.test(email)) {
    alert('Please enter a valid email address');
    emailInput.focus();
    return false;
  }
  
  // Redirect to calendar page with email parameter
  window.location.href = `/calendar?form_type=LOI Call&host=Evan&email=${encodeURIComponent(email)}`;
  return false;
}
</script>
{% endblock %}

{% block content %}

  <div class="container py-2">
    <div class="row justify-content-center">
      <div class="col-lg-12">
        <div class="card shadow-sm border-0">
          <div class="card-header bg-white border-0 pt-4 pb-3">
            <h2 class="text-center mb-2">LOI Questions</h2>
            <p class="text-center text-muted mb-0">Please fill out the information below to generate your analysis</p>
          </div>
          
          <div class="card-body p-4 p-md-5">
            {% if error %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              {{ error }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}
            {% if success %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
              {{ success }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}


            <form method="POST" action="/submit-business" enctype="multipart/form-data">
              
              <!-- Personal Information Section -->
              <div class="mb-5">
                <h5 class="border-bottom pb-2 mb-4">Personal Information</h5>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="full_name" class="form-label fw-semibold">Full Name</label>
                    <input type="text" class="form-control form-control-lg" id="full_name" name="full_name" required value="{{ form_data.full_name if form_data else '' }}">
                  </div>
                  <div class="col-md-6">
                    <label for="email" class="form-label fw-semibold">Email</label>
                    <input type="email" class="form-control form-control-lg" id="email" name="email" required value="{{ form_data.email if form_data else '' }}">
                  </div>
                </div>
              </div>

              <!-- Business Details Section -->
              <div class="mb-5">
                <h5 class="border-bottom pb-2 mb-4">Business Details</h5>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="industry" class="form-label fw-semibold">Industry</label>
                    <input type="text" class="form-control form-control-lg" id="industry" name="industry"  value="{{ form_data.industry if form_data else '' }}">
                  </div>
                  <div class="col-md-6">
                    <label for="location" class="form-label fw-semibold">Location</label>
                    <input type="text" class="form-control form-control-lg" id="location" name="location"  value="{{ form_data.location if form_data else '' }}">
                  </div>
                </div>
              </div>

              <!-- Financial Information Section -->
              <div class="mb-5">
                <h5 class="border-bottom pb-2 mb-4">Financial Information</h5>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="purchase_price" class="form-label fw-semibold">Purchase Price</label>
                    <div class="input-group input-group-lg">
                      <span class="input-group-text">$</span>
                      <input type="number" class="form-control" id="purchase_price" name="purchase_price" min="0" step="any"  value="{{ form_data.purchase_price if form_data else '' }}">
                    </div>
                  </div>
                  <div class="col-md-6">
                    <label for="revenue" class="form-label fw-semibold">Offer Price</label>
                    <div class="input-group input-group-lg">
                      <span class="input-group-text">$</span>
                      <input type="number" class="form-control" id="revenue" name="revenue" min="0" step="any"  value="{{ form_data.revenue if form_data else '' }}">
                    </div>
                  </div>
                  <!--  <div class="col-md-4">
                    <label for="avg_sde" class="form-label fw-semibold">Avg SDE</label>
                    <div class="input-group input-group-lg">
                      <span class="input-group-text">$</span>
                      <input type="number" class="form-control" id="avg_sde" name="avg_sde" min="0" step="any"  value="{{ form_data.avg_sde if form_data else '' }}">
                    </div>
                  </div>  -->
                </div>
              </div>

              <!-- Deal Information Section -->
              <div class="mb-5">
                <h5 class="border-bottom pb-2 mb-4">Deal Information</h5>
                <div class="row g-3">
                  <!-- <div class="col-md-6">
                    <label for="seller_role" class="form-label fw-semibold">Seller Role</label>
                    <input type="text" class="form-control form-control-lg" id="seller_role" name="seller_role"  value="{{ form_data.seller_role if form_data else '' }}">
                  </div> -->
                  <div class="col-md-12">
                    <label for="reason_for_selling" class="form-label fw-semibold">Reason for Selling</label>
                    <input type="text" class="form-control form-control-lg" id="reason_for_selling" name="reason_for_selling"  value="{{ form_data.reason_for_selling if form_data else '' }}">
                  </div>
                </div>
                
                <div class="row g-3 mt-1">
                  <div class="col-md-12">
                    <label for="owner_involvement" class="form-label fw-semibold">Owner Involvement (high-level role description, hours per week, etc.)</label>
                    <textarea class="form-control" id="owner_involvement" name="owner_involvement" rows="3">{{ form_data.owner_involvement if form_data else '' }}</textarea>
                  </div>
                </div>

                <div class="row g-3 mt-1">
                  <div class="col-md-6">
                    <label for="customer_concentration_risk" class="form-label fw-semibold">Customer Concentration Risk</label>
                    <input type="text" class="form-control form-control-lg" id="customer_concentration_risk" name="customer_concentration_risk"  value="{{ form_data.customer_concentration_risk if form_data else '' }}">
                  </div>
                  <div class="col-md-6">
                    <label for="deal_competitiveness" class="form-label fw-semibold">How Competitive is the Deal?</label>
                    <input type="text" class="form-control form-control-lg" id="deal_competitiveness" name="deal_competitiveness"  value="{{ form_data.deal_competitiveness if form_data else '' }}">
                  </div>
                </div>


                <div class="row g-3 mt-1">
                  <div class="col-md-12">
                    <div class="form-check form-check-inline">
                      <input class="form-check-input" type="checkbox" id="seller_note_openness" name="seller_note_openness" value="yes" {{ 'checked' if form_data and form_data.seller_note_openness else '' }}>
                      <label class="form-check-label fw-semibold" for="seller_note_openness">
                        Is the Seller Open to a Seller Note?
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Additional Questions Section -->
              <div class="mb-5">
                <h5 class="border-bottom pb-2 mb-4">Additional Questions</h5>
                
                <!-- <div class="mb-4">
                  <label for="cim_search_narrative_fit" class="form-label fw-semibold">Does the CIM fit your Search Narrative & your Search Narrative Question Guide?</label>
                  <select class="form-select form-select-lg" id="cim_search_narrative_fit" name="cim_search_narrative_fit" onchange="toggleSearchNarrative()">
                    <option value="">Select...</option>
                    <option value="Yes" {{ 'selected' if form_data and form_data.cim_search_narrative_fit == 'Yes' else '' }}>Yes</option>
                    <option value="No" {{ 'selected' if form_data and form_data.cim_search_narrative_fit == 'No' else '' }}>No</option>
                  </select>
                </div> -->

                <!-- <div class="mb-4" id="search_narrative_section" style="display: {{ 'block' if form_data and form_data.cim_search_narrative_fit == 'Yes' else 'none' }};">
                  <label for="search_narrative_relation" class="form-label fw-semibold">How does this relate to your search narrative?</label>
                  <textarea class="form-control" id="search_narrative_relation" name="search_narrative_relation" rows="4">{{ form_data.search_narrative_relation if form_data else '' }}</textarea>
                </div> -->

                <div class="mb-4">
                  <label for="deal_likes_dislikes" class="form-label fw-semibold">Key factors that impact valuation / multiple (what makes this deal strong or weak?)</label>
                  <textarea class="form-control" id="deal_likes_dislikes" name="deal_likes_dislikes" rows="4" >{{ form_data.deal_likes_dislikes if form_data else '' }}</textarea>
                </div>

                <div class="mb-4">
                  <label for="deal_questions_concerns" class="form-label fw-semibold">What leverage points do you see (red flags, risks, inconsistencies) and your negotiation angle or offer strategy?</label>
                  <textarea class="form-control" id="deal_questions_concerns" name="deal_questions_concerns" rows="4">{{ form_data.deal_questions_concerns if form_data else '' }}</textarea>
                </div>
              </div>

              <!-- File Upload Section -->
              <div class="mb-5">
                <h5 class="border-bottom pb-2 mb-4">Documents</h5>
                <div class="mb-3">
                  <label for="files" class="form-label fw-semibold">Upload all files that help us review your deal here</label>
                  <input type="file" class="form-control form-control-lg" id="files" name="files" multiple>
                  <div class="form-text">You can upload multiple files (PDF, Excel, Word, etc.)</div>
                </div>
              </div>

              <!-- Terms and Conditions -->
              <div class="mb-4">
                <div class="card bg-light border-0">
                  <div class="card-body">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="terms_accepted" name="terms_accepted" required>
                      <label class="form-check-label" for="terms_accepted">
                        <strong>Confirm terms and conditions:</strong> This data can be reviewed live on a call with others. We do not take any responsibility for it.
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Schedule Live Call Button -->
              <div class="mb-4">
                <a href="#" class="btn btn-primary rounded-pill btn-lg px-5 w-100" id="scheduleCallBtn" onclick="handleScheduleCall(event)" style="pointer-events: auto; opacity: 0.6; cursor: not-allowed;">
                  ðŸ“… Schedule a Live Call
                </a>
                <small class="text-muted d-block mt-2">Please enter your email above to schedule a call</small>
              </div>


              <!-- Action Buttons -->
              <div class="d-flex gap-3 justify-content-between flex-wrap">
                <a href="/" class="btn btn-outline-secondary rounded-pill btn-lg px-5">Back to Home</a>
                <button type="submit" class="btn submit-btn rounded-pill btn-lg px-5">Submit Information</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

{% endblock %}