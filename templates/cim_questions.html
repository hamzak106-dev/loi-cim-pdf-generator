{% extends "base.html" %}

{% block title %}CIM Questions{% endblock %}

{% block scripts %}
<script>
// Define functions IMMEDIATELY - before content loads
window.currentFormType = 'CIM Call';
window.selectedHost = null;

// Define selectHost in head block so it's available immediately
window.selectHost = function(host) {
  window.selectedHost = host;
  const hostTitle = document.getElementById('hostTitle');
  const hostSelection = document.getElementById('hostSelection');
  const meetingsList = document.getElementById('meetingsList');
  
  if (hostTitle) hostTitle.textContent = `Available Calls with ${host}`;
  if (hostSelection) hostSelection.style.display = 'none';
  if (meetingsList) meetingsList.style.display = 'block';
  
  window.loadAvailableMeetings(host);
};

window.backToHostSelection = function() {
  window.selectedHost = null;
  const hostSelection = document.getElementById('hostSelection');
  const meetingsList = document.getElementById('meetingsList');
  
  if (hostSelection) hostSelection.style.display = 'block';
  if (meetingsList) meetingsList.style.display = 'none';
};

// Define loadAvailableMeetings in head block
window.loadAvailableMeetings = function(host) {
  const container = document.getElementById('meetingsContainer');
  if (!container) {
    console.error('meetingsContainer not found');
    return;
  }
  container.innerHTML = '<p class="text-dark">Loading available meetings...</p>';
  
  const formType = window.currentFormType || 'CIM Call';
  
  // Step 1: Get google_event_ids from /api/meetings/available
  fetch(`/api/meetings/available?form_type=${formType}&host=${encodeURIComponent(host)}&limit=3`)
    .then(response => {
      if (!response.ok) {
        throw new Error('Network response was not ok: ' + response.status);
      }
      return response.json();
    })
    .then(meetingInstances => {
      if (!meetingInstances || meetingInstances.length === 0) {
        container.innerHTML = '<p class="text-muted">No available meetings at this time.</p>';
        return;
      }
      
      container.innerHTML = '<div class="list-group"></div>';
      const listGroup = container.querySelector('.list-group');
      
      // Step 2: For each google_event_id, fetch full details from Google Calendar
      const fetchPromises = meetingInstances.map(instance => {
        const eventId = instance.google_event_id;
        return fetch(`/api/meetings/get-event/${encodeURIComponent(eventId)}`)
          .then(response => {
            if (!response.ok) {
              throw new Error(`Failed to fetch event ${eventId}: ${response.status}`);
            }
            return response.json();
          })
          .then(eventDetails => {
            // Merge instance info (guest_count, available_slots) with event details
            return {
              ...eventDetails,
              guest_count: instance.guest_count,
              max_guests: instance.max_guests,
              available_slots: instance.available_slots,
              host: instance.host,
              form_type: instance.form_type
            };
          })
          .catch(error => {
            console.error(`Error fetching event ${eventId}:`, error);
            return null; // Return null for failed fetches
          });
      });
      
      // Wait for all event details to be fetched
      Promise.all(fetchPromises)
        .then(meetings => {
          // Filter out null results (failed fetches)
          meetings = meetings.filter(m => m !== null);
          
          if (meetings.length === 0) {
            container.innerHTML = '<p class="text-muted">No available meetings at this time.</p>';
            return;
          }
          
          // Display meetings
          meetings.forEach(meeting => {
            const date = new Date(meeting.instance_time);
            const dateStr = date.toLocaleDateString('en-US', { 
              weekday: 'long', 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric',
              timeZone: 'America/New_York'
            });
            const timeStr = date.toLocaleTimeString('en-US', { 
              hour: 'numeric', 
              minute: '2-digit',
              timeZone: 'America/New_York'
            });
            const isFull = meeting.available_slots === 0;
            
            // Create element instead of HTML string
            const itemDiv = document.createElement('div');
            itemDiv.className = `list-group-item meeting-item ${isFull ? 'list-group-item-secondary' : 'cursor-pointer'}`;
            itemDiv.style.cssText = `cursor: ${isFull ? 'not-allowed' : 'pointer'}; border-radius: 8px; margin-bottom: 10px;`;
            
            // Store meeting data as property instead of attribute
            itemDiv._meetingData = meeting;
            
            itemDiv.innerHTML = `
              <div class="d-flex w-100 justify-content-between align-items-center">
                <div>
                  <h6 class="mb-1">${meeting.title || 'Untitled Event'}</h6>
                  <p class="mb-1"><strong style="color: red;">${dateStr} at ${timeStr}</strong></p>
                  <small>Available slots: ${meeting.available_slots} / ${meeting.max_guests}</small>
                </div>
                <div>
                  ${isFull ? 
                    '<span class="badge bg-danger">No Slots Available</span>' : 
                    '<i class="bi bi-chevron-right"></i>'
                  }
                </div>
              </div>
            `;
            
            // Add click listener if not full
            if (!isFull) {
              itemDiv.addEventListener('click', function() {
                window.showMeetingDetails(this._meetingData);
              });
            }
            
            listGroup.appendChild(itemDiv);
          });
        })
        .catch(error => {
          console.error('Error processing meeting details:', error);
          container.innerHTML = '<p class="text-danger">Error loading meeting details. Please try again.</p>';
        });
    })
    .catch(error => {
      console.error('Error loading meetings:', error);
      container.innerHTML = '<p class="text-danger">Error loading meetings. Please try again.</p>';
    });
};

window.openScheduleModal = function(formType) {
  try {
    window.currentFormType = formType || 'CIM Call';
    window.selectedHost = null;
    
    const hostSelection = document.getElementById('hostSelection');
    const meetingsList = document.getElementById('meetingsList');
    const modalElement = document.getElementById('scheduleMeetingModal');
    
    if (!modalElement) {
      alert('Error: Modal not found. Please refresh the page.');
      return;
    }
    
    // Reset modal state
    if (hostSelection) hostSelection.style.display = 'block';
    if (meetingsList) meetingsList.style.display = 'none';
    
    if (typeof bootstrap === 'undefined') {
      alert('Error: Bootstrap is not loaded. Please refresh the page.');
      return;
    }
    
    const modal = new bootstrap.Modal(modalElement);
    modal.show();
  } catch (error) {
    console.error('Error opening schedule modal:', error);
    alert('Error opening schedule modal: ' + error.message);
  }
};

// Define showMeetingDetails in head block
window.showMeetingDetails = function(meeting) {
  window.currentMeetingDetails = meeting;
  const date = new Date(meeting.instance_time);
  const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
  const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
  
  const dayName = dayNames[date.getDay()];
  const month = monthNames[date.getMonth()];
  const day = date.getDate();
  const timeStr = date.toLocaleTimeString('en-US', { 
    hour: 'numeric', 
    minute: '2-digit',
    timeZone: 'America/New_York'
  });
  
  function getOrdinalSuffix(day) {
    if (day > 3 && day < 21) return 'th';
    switch (day % 10) {
      case 1: return 'st';
      case 2: return 'nd';
      case 3: return 'rd';
      default: return 'th';
    }
  }
  
  function getEndTime(startTime) {
    const match = startTime.match(/(\d+):(\d+)\s*(AM|PM)/i);
    if (!match) return startTime;
    let hour = parseInt(match[1]);
    const minute = match[2];
    const ampm = match[3].toUpperCase();
    hour += 1;
    if (hour === 12) {
      return `12:${minute} ${ampm === 'AM' ? 'PM' : 'AM'}`;
    } else if (hour === 13) {
      return `1:${minute} PM`;
    } else {
      return `${hour}:${minute} ${ampm}`;
    }
  }
  
  const dateFormatted = `${dayName}, ${month} ${day}${getOrdinalSuffix(day)} @ ${timeStr} - ${getEndTime(timeStr)}`;
  const isFull = meeting.available_slots === 0;
  
  document.getElementById('meetingDetailsTitle').textContent = (meeting.title || 'Untitled Event').toUpperCase();
  document.getElementById('meetingDetailsHost').textContent = `WITH ${(meeting.host || 'Host').toUpperCase()}`;
  
  // Escape HTML to prevent XSS and syntax errors
  const escapeHtml = (text) => {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
  };
  
  const title = escapeHtml(meeting.title);
  const meetingLink = escapeHtml(meeting.meeting_link || 'To be added');
  const description = meeting.description ? escapeHtml(meeting.description) : '';
  
  let content = '<h5 class="mb-3" style="font-weight: bold; color: #2C3E50;">' + title + '</h5>';
  content += '<div class="mb-3">';
  content += '<div class="d-flex align-items-center mb-2">';
  content += '<i class="bi bi-calendar-event me-2" style="color: #0D3872;"></i>';
  content += '<span style="font-weight: 500;">' + escapeHtml(dateFormatted) + '</span>';
  content += '</div>';
  content += '<small class="text-muted ms-4">New York time</small>';
  content += '</div>';
  content += '<div class="mb-3">';
  content += '<div class="d-flex align-items-center mb-2">';
  content += '<i class="bi bi-camera-video me-2" style="color: #0D3872;"></i>';
  content += '<a href="' + meetingLink + '" target="_blank" style="color: #0D3872; text-decoration: none;">' + meetingLink + '</a>';
  content += '</div>';
  content += '</div>';
  
  if (description) {
    content += '<div class="mb-3"><p style="color: #2C3E50; line-height: 1.6;">' + description + '</p></div>';
  }
  
  content += '<div class="mb-3">';
  content += '<p class="mb-0" style="color: #5D6D7E; font-size: 0.9rem;">';
  content += '<strong>Available slots:</strong> ' + meeting.available_slots + ' / ' + meeting.max_guests;
  content += '</p>';
  content += '</div>';
  content += '<div class="d-grid mt-4">';
  
  if (isFull) {
    content += '<button class="btn btn-secondary btn-lg" disabled>No Slots Available</button>';
  } else {
    content += '<button class="btn btn-primary btn-lg" onclick="window.registerForMeeting()" style="background: linear-gradient(135deg, #0D3872 0%, #1a5a9e 100%); border: none; border-radius: 8px; padding: 12px;">';
    content += '<i class="bi bi-calendar-check me-2"></i>Register';
    content += '</button>';
  }
  
  content += '</div>';
  
  document.getElementById('meetingDetailsContent').innerHTML = content;
  bootstrap.Modal.getInstance(document.getElementById('scheduleMeetingModal')).hide();
  const detailsModal = new bootstrap.Modal(document.getElementById('meetingDetailsModal'));
  detailsModal.show();
};

// Define registerForMeeting in head block
window.registerForMeeting = function() {
  if (!window.currentMeetingDetails) {
    alert('No meeting selected. Please try again.');
    return;
  }
  
  const fullName = document.getElementById('full_name');
  const email = document.getElementById('email');
  
  if (!fullName || !email) {
    alert('Please fill in your name and email before registering.');
    return;
  }
  
  const fullNameValue = fullName.value.trim();
  const emailValue = email.value.trim();
  
  if (!fullNameValue || !emailValue) {
    alert('Please fill in your name and email before registering.');
    return;
  }
  
  // Validate email format
  const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
  if (!emailRegex.test(emailValue)) {
    alert('Please enter a valid email address.');
    return;
  }
  
  const formData = new FormData();
  formData.append('instance_id', window.currentMeetingDetails.id);
  formData.append('full_name', fullNameValue);
  formData.append('email', emailValue);
  
  // Show loading state
  const registerBtn = document.querySelector('#meetingDetailsContent button[onclick*="registerForMeeting"]');
  if (registerBtn) {
    registerBtn.disabled = true;
    registerBtn.innerHTML = '<i class="bi bi-hourglass-split me-2"></i>Registering...';
  }
  
  fetch('/api/meetings/register', {
    method: 'POST',
    body: formData
  })
  .then(response => response.json())
  .then(result => {
    if (result.success) {
      const meetingLink = result.registration?.meeting_link || window.currentMeetingDetails.meeting_link || 'To be added';
      const message = `Successfully registered for the meeting!\n\n` +
                     `Meeting Link: ${meetingLink}\n\n` +
                     `You will receive meeting details via email.`;
      alert(message);
      
      // Close modals
      const detailsModal = bootstrap.Modal.getInstance(document.getElementById('meetingDetailsModal'));
      if (detailsModal) detailsModal.hide();
      
      // Reload meetings to update available slots
      if (window.selectedHost) {
        window.loadAvailableMeetings(window.selectedHost);
      }
    } else {
      if (result.already_registered) {
        alert('This email is already registered for this meeting. Please use a different email address.');
      } else if (result.full) {
        alert('This meeting is full. Maximum 10 registrations allowed.');
      } else {
        alert('Error: ' + (result.error || 'Failed to register. Please try again.'));
      }
      
      // Re-enable button
      if (registerBtn) {
        registerBtn.disabled = false;
        registerBtn.innerHTML = '<i class="bi bi-calendar-check me-2"></i>Register';
      }
    }
  })
  .catch(error => {
    console.error('Error registering:', error);
    alert('Error registering for meeting. Please try again.');
    
    // Re-enable button
    if (registerBtn) {
      registerBtn.disabled = false;
      registerBtn.innerHTML = '<i class="bi bi-calendar-check me-2"></i>Register';
    }
  });
};

// Verify functions are loaded
console.log('âœ… Functions loaded in head block:', {
  openScheduleModal: typeof window.openScheduleModal === 'function',
  loadAvailableMeetings: typeof window.loadAvailableMeetings === 'function',
  showMeetingDetails: typeof window.showMeetingDetails === 'function',
  registerForMeeting: typeof window.registerForMeeting === 'function',
  selectHost: typeof window.selectHost === 'function',
  backToHostSelection: typeof window.backToHostSelection === 'function'
});
</script>
{% endblock %}

{% block content %}
  <div class="container py-2">
    <div class="row justify-content-center">
      <div class="col-lg-12">
        <div class="card shadow-sm border-0">
          <div class="card-header bg-white border-0 pt-4 pb-3">
            <h2 class="text-center mb-2">CIM Questions</h2>
            <p class="text-center text-muted mb-0">Please fill out the information below to generate your analysis</p>
          </div>
          
          <div class="card-body p-4 p-md-5">
            {% if error %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              {{ error }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}
            {% if success %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
              {{ success }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}


            <form method="POST" action="/submit-cim" enctype="multipart/form-data">
              
              <!-- Personal Information Section -->
              <div class="mb-5">
                <h5 class="border-bottom pb-2 mb-4">Personal Information</h5>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="full_name" class="form-label fw-semibold">Full Name</label>
                    <input type="text" class="form-control form-control-lg" id="full_name" name="full_name" required value="{{ form_data.full_name if form_data else '' }}">
                  </div>
                  <div class="col-md-6">
                    <label for="email" class="form-label fw-semibold">Email</label>
                    <input type="email" class="form-control form-control-lg" id="email" name="email" required value="{{ form_data.email if form_data else '' }}">
                  </div>
                </div>
              </div>

              <!-- Business Details Section -->
              <div class="mb-5">
                <h5 class="border-bottom pb-2 mb-4">Business Details</h5>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="industry" class="form-label fw-semibold">Industry</label>
                    <input type="text" class="form-control form-control-lg" id="industry" name="industry"  value="{{ form_data.industry if form_data else '' }}">
                  </div>
                  <div class="col-md-6">
                    <label for="location" class="form-label fw-semibold">Location</label>
                    <input type="text" class="form-control form-control-lg" id="location" name="location"  value="{{ form_data.location if form_data else '' }}">
                  </div>
                </div>
              </div>

              <!-- Financial Information Section -->
              <div class="mb-5">
                <h5 class="border-bottom pb-2 mb-4">Financial Information</h5>
                <div class="row g-3">
                  <div class="col-md-3">
                    <label for="purchase_price" class="form-label fw-semibold">Purchase Price</label>
                    <div class="input-group input-group-lg">
                      <span class="input-group-text">$</span>
                      <input type="number" class="form-control" id="purchase_price" name="purchase_price" min="0" step="any"  value="{{ form_data.purchase_price if form_data else '' }}">
                    </div>
                  </div>
                  <div class="col-md-3">
                    <label for="revenue" class="form-label fw-semibold">Revenue</label>
                    <div class="input-group input-group-lg">
                      <span class="input-group-text">$</span>
                      <input type="number" class="form-control" id="revenue" name="revenue" min="0" step="any"  value="{{ form_data.revenue if form_data else '' }}">
                    </div>
                  </div>
                  <div class="col-md-3">
                    <label for="avg_sde" class="form-label fw-semibold">Avg SDE</label>
                    <div class="input-group input-group-lg">
                      <span class="input-group-text">$</span>
                      <input type="number" class="form-control" id="avg_sde" name="avg_sde" min="0" step="any"  value="{{ form_data.avg_sde if form_data else '' }}">
                    </div>
                  </div>
                  <div class="col-md-3">
                    <label for="total_adjustments" class="form-label fw-semibold">Total $ Adjustments</label>
                    <div class="input-group input-group-lg">
                      <span class="input-group-text">$</span>
                      <input type="number" class="form-control" id="total_adjustments" name="total_adjustments" min="0" step="any"  value="{{ form_data.total_adjustments if form_data else '' }}">
                    </div>
                  </div>
                </div>
              </div>

              <!-- Deal Information Section -->
              <div class="mb-5">
                <h5 class="border-bottom pb-2 mb-4">Deal Information</h5>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="seller_role" class="form-label fw-semibold">Seller Role</label>
                    <input type="text" class="form-control form-control-lg" id="seller_role" name="seller_role"  value="{{ form_data.seller_role if form_data else '' }}">
                  </div>
                  <div class="col-md-6">
                    <label for="reason_for_selling" class="form-label fw-semibold">Reason for Selling</label>
                    <input type="text" class="form-control form-control-lg" id="reason_for_selling" name="reason_for_selling"  value="{{ form_data.reason_for_selling if form_data else '' }}">
                  </div>
                </div>
                
                <div class="row g-3 mt-1">
                  <div class="col-md-12">
                    <label for="owner_involvement" class="form-label fw-semibold">Owner Involvement (high-level role description, hours per week, etc.)</label>
                    <textarea class="form-control" id="owner_involvement" name="owner_involvement" rows="3">{{ form_data.owner_involvement if form_data else '' }}</textarea>
                  </div>
                </div>

                <div class="row g-3 mt-1">
                  <div class="col-md-4">
                    <label for="gm_in_place" class="form-label fw-semibold">GM in Place?</label>
                    <select class="form-select form-select-lg" id="gm_in_place" name="gm_in_place">
                      <option value="">Select...</option>
                      <option value="Yes" {{ 'selected' if form_data and form_data.gm_in_place == 'Yes' else '' }}>Yes</option>
                      <option value="No" {{ 'selected' if form_data and form_data.gm_in_place == 'No' else '' }}>No</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="tenure_of_gm" class="form-label fw-semibold">Tenure of GM (if applicable)</label>
                    <input type="text" class="form-control form-control-lg" id="tenure_of_gm" name="tenure_of_gm"  value="{{ form_data.tenure_of_gm if form_data else '' }}">
                  </div>
                  <div class="col-md-4">
                    <label for="number_of_employees" class="form-label fw-semibold">Number of Employees</label>
                    <input type="number" class="form-control form-control-lg" id="number_of_employees" name="number_of_employees" min="0"  value="{{ form_data.number_of_employees if form_data else '' }}">
                  </div>
                </div>
              </div>

              <!-- Additional Questions Section -->
              <div class="mb-5">
                <h5 class="border-bottom pb-2 mb-4">Additional Questions</h5>
                
                <div class="mb-4">
                  <label for="cim_search_narrative_fit" class="form-label fw-semibold">Does the CIM fit your Search Narrative & your Search Narrative Question Guide?</label>
                  <select class="form-select form-select-lg" id="cim_search_narrative_fit" name="cim_search_narrative_fit" onchange="toggleSearchNarrative()">
                    <option value="">Select...</option>
                    <option value="Yes" {{ 'selected' if form_data and form_data.cim_search_narrative_fit == 'Yes' else '' }}>Yes</option>
                    <option value="No" {{ 'selected' if form_data and form_data.cim_search_narrative_fit == 'No' else '' }}>No</option>
                  </select>
                </div>

                <div class="mb-4" id="search_narrative_section" style="display: {{ 'block' if form_data and form_data.cim_search_narrative_fit == 'Yes' else 'none' }};">
                  <label for="search_narrative_relation" class="form-label fw-semibold">How does this relate to your search narrative?</label>
                  <textarea class="form-control" id="search_narrative_relation" name="search_narrative_relation" rows="4">{{ form_data.search_narrative_relation if form_data else '' }}</textarea>
                </div>

                <div class="mb-4">
                  <label for="deal_likes_dislikes" class="form-label fw-semibold">What do you like/don't like about the deal?</label>
                  <textarea class="form-control" id="deal_likes_dislikes" name="deal_likes_dislikes" rows="4" >{{ form_data.deal_likes_dislikes if form_data else '' }}</textarea>
                </div>

                <div class="mb-4">
                  <label for="deal_questions_concerns" class="form-label fw-semibold">What questions/concerns do you have about the deal?</label>
                  <textarea class="form-control" id="deal_questions_concerns" name="deal_questions_concerns" rows="4">{{ form_data.deal_questions_concerns if form_data else '' }}</textarea>
                </div>
              </div>

              <!-- File Upload Section -->
              <div class="mb-5">
                <h5 class="border-bottom pb-2 mb-4">Documents</h5>
                <div class="mb-3">
                  <label for="files" class="form-label fw-semibold">Upload all files that help us review your deal here</label>
                  <input type="file" class="form-control form-control-lg" id="files" name="files" multiple>
                  <div class="form-text">You can upload multiple files (PDF, Excel, Word, etc.)</div>
                </div>
              </div>

              <!-- Terms and Conditions -->
              <div class="mb-4">
                <div class="card bg-light border-0">
                  <div class="card-body">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="terms_accepted" name="terms_accepted" required>
                      <label class="form-check-label" for="terms_accepted">
                        <strong>Confirm terms and conditions:</strong> This data can be reviewed live on a call with others. We do not take any responsibility for it.
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Schedule Live Call Button -->
              <div class="mb-4">
                <button type="button" class="btn btn-primary rounded-pill btn-lg px-5 w-100" id="scheduleCallBtn" data-form-type="CIM Call" onclick="window.openScheduleModal('CIM Call'); return false;">
                  ðŸ“… Schedule a Live Call
                </button>
              </div>

              <!-- Action Buttons -->
              <div class="d-flex gap-3 justify-content-between flex-wrap">
                <a href="/" class="btn btn-outline-secondary rounded-pill btn-lg px-5">Back to Home</a>
                <button type="submit" class="btn submit-btn rounded-pill btn-lg px-5">Submit Information</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

<!-- Schedule Meeting Modal -->
<div class="modal fade" id="scheduleMeetingModal" tabindex="-1" aria-labelledby="scheduleMeetingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header text-dark">
        <h5 class="modal-title text-dark" id="scheduleMeetingModalLabel">Schedule a Live Call</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-dark">
        <div id="hostSelection" style="display: block;">
          <h6 class="text-dark">Select Host:</h6>
          <div class="d-grid gap-2">
            <button type="button" class="btn btn-outline-primary btn-lg" onclick="window.selectHost('Ben'); return false;">Call with Ben</button>
            <button type="button" class="btn btn-outline-primary btn-lg" onclick="window.selectHost('Mitch'); return false;">Call with Mitch</button>
          </div>
        </div>
        
        <div id="meetingsList" style="display: none;">
          <h6 id="hostTitle" class="text-dark"></h6>
          <div id="meetingsContainer"></div>
          <button type="button" class="btn btn-secondary mt-3" onclick="window.backToHostSelection(); return false;">Back</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Meeting Details Modal -->
<div class="modal fade" id="meetingDetailsModal" tabindex="-1" aria-labelledby="meetingDetailsModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" style="max-width: 600px;">
    <div class="modal-content" style="border-radius: 12px; overflow: hidden;">
      <div class="modal-header" style="background: linear-gradient(135deg, #0D3872 0%, #1a5a9e 100%); color: white; border: none; padding: 30px;">
        <div class="w-100 text-center">
          <h4 class="modal-title mb-2" id="meetingDetailsTitle" style="font-weight: bold; font-size: 1.5rem;">MEETING TITLE</h4>
          <p class="mb-0" style="font-size: 0.9rem; opacity: 0.9;" id="meetingDetailsHost">WITH HOST</p>
        </div>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close" style="position: absolute; top: 15px; right: 15px;"></button>
      </div>
      <div class="modal-body" style="padding: 30px; background: white;">
        <div id="meetingDetailsContent">
          <!-- Content will be populated by JavaScript -->
        </div>
      </div>
    </div>
  </div>
</div>
{% endblock %}

<script>
// All functions are defined in head block, just define toggleSearchNarrative here

function toggleSearchNarrative() {
  const select = document.getElementById('cim_search_narrative_fit');
  const section = document.getElementById('search_narrative_section');
  
  if (select.value === 'Yes') {
    section.style.display = 'block';
  } else {
    section.style.display = 'none';
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  toggleSearchNarrative();
  
  // Scroll to top if success message is present
  const successAlert = document.querySelector('.alert-success');
  if (successAlert) {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    setTimeout(function() {
      if (typeof bootstrap !== 'undefined') {
        const alert = bootstrap.Alert.getOrCreateInstance(successAlert);
        alert.close();
      }
    }, 10000);
  }
});
</script>