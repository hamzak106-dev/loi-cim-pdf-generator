{% extends "base.html" %}

{% block title %}CIM Questions{% endblock %}

{% block scripts %}
<script>
// Function to show host selection modal for CIM Call
function showHostSelectionModal() {
  const modal = `
    <div class="modal fade" id="hostSelectionModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header" style="background-color: rgba(0, 0, 0, 0.3);">
            <h5 class="modal-title">Select Host for CIM Call</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="d-grid gap-2">
              <a href="/calendar?form_type=CIM Call&host=Ben" class="btn btn-primary">Ben</a>
              <a href="/calendar?form_type=CIM Call&host=Mitch" class="btn btn-primary">Mitch</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal if any
  const existing = document.getElementById('hostSelectionModal');
  if (existing) existing.remove();
  
  // Add modal to body
  document.body.insertAdjacentHTML('beforeend', modal);
  
  // Show modal
  const modalElement = new bootstrap.Modal(document.getElementById('hostSelectionModal'));
  modalElement.show();
}

// Handle Schedule Call button click - check email first
function handleScheduleCall(event) {
  event.preventDefault();
  const emailInput = document.getElementById('email');
  const email = emailInput ? emailInput.value.trim() : '';
  
  if (!email) {
    alert('Please enter your email address first');
    if (emailInput) emailInput.focus();
    return false;
  }
  
  // Validate email format
  const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
  if (!emailPattern.test(email)) {
    alert('Please enter a valid email address');
    if (emailInput) emailInput.focus();
    return false;
  }
  
  // For CIM Call, show host selection modal
  showHostSelectionModalWithEmail(email);
  return false;
}

// Function to open schedule modal (for CIM Call - shows host selection)
function openScheduleModal(formType) {
  if (formType === 'CIM Call') {
    showHostSelectionModal();
  } else {
    window.location.href = '/calendar?form_type=' + encodeURIComponent(formType);
  }
}

// Show host selection modal with email
function showHostSelectionModalWithEmail(email) {
  const modal = `
    <div class="modal fade" id="hostSelectionModal" tabindex="-1">
      <div class="modal-dialog">
        <div class="modal-content">
          <div class="modal-header" ">
            <h5 class="modal-title" style="color: black;">Select Host for CIM Call</h5>
            <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
          </div>
          <div class="modal-body">
            <div class="d-grid gap-2">
              <a href="/calendar?form_type=CIM Call&host=Ben&email=${encodeURIComponent(email)}" class="btn btn-primary">Ben</a>
              <a href="/calendar?form_type=CIM Call&host=Mitch&email=${encodeURIComponent(email)}" class="btn btn-primary">Mitch</a>
            </div>
          </div>
        </div>
      </div>
    </div>
  `;
  
  // Remove existing modal if any
  const existing = document.getElementById('hostSelectionModal');
  if (existing) existing.remove();
  
  // Add modal to body
  document.body.insertAdjacentHTML('beforeend', modal);
  
  // Show modal
  const modalElement = new bootstrap.Modal(document.getElementById('hostSelectionModal'));
  modalElement.show();
}

// Fetch and display calendar events in calendar view
document.addEventListener('DOMContentLoaded', function() {
  fetchCalendarEventsForCIM();
});

async function fetchCalendarEventsForCIM() {
  const loadingEl = document.getElementById('calendarLoading');
  const errorEl = document.getElementById('calendarError');
  const calendarViewEl = document.getElementById('calendarView');
  
  try {
    loadingEl.style.display = 'block';
    errorEl.style.display = 'none';
    calendarViewEl.innerHTML = '';
    
    // Get calendar_id from backend template variable
    const calendarId = '{{ calendar_id }}' || 'primary';
    const response = await fetch(`/api/calendar/events?calendar_id=${encodeURIComponent(calendarId)}`);
    const data = await response.json();
    
    loadingEl.style.display = 'none';
    
    if (!data.success || !data.events || data.events.length === 0) {
      calendarViewEl.innerHTML = '<div class="col-12"><div class="text-muted text-center py-3">No upcoming events found.</div></div>';
      return;
    }
    
    // Filter future events and group by date
    // API returns start/end as ISO datetime strings (e.g., "2025-12-02T19:00:00+05:00")
    const now = new Date();
    const futureEvents = data.events
      .filter(event => {
        // Handle both ISO string format and object format for compatibility
        const startTime = typeof event.start === 'string' ? event.start : (event.start?.dateTime || event.start?.date);
        return startTime && new Date(startTime) >= now;
      })
      .sort((a, b) => {
        const startA = typeof a.start === 'string' ? a.start : (a.start?.dateTime || a.start?.date || 0);
        const startB = typeof b.start === 'string' ? b.start : (b.start?.dateTime || b.start?.date || 0);
        return new Date(startA) - new Date(startB);
      })
      .slice(0, 30); // Show up to 30 upcoming events
    
    if (futureEvents.length === 0) {
      calendarViewEl.innerHTML = '<div class="col-12"><div class="text-muted text-center py-3">No upcoming events found.</div></div>';
      return;
    }
    
    // Group events by date
    const eventsByDate = {};
    futureEvents.forEach(event => {
      // Handle both ISO string format and object format
      const startTime = typeof event.start === 'string' ? event.start : (event.start?.dateTime || event.start?.date);
      const dateKey = new Date(startTime).toDateString();
      if (!eventsByDate[dateKey]) {
        eventsByDate[dateKey] = [];
      }
      eventsByDate[dateKey].push(event);
    });
    
    // Display events in calendar-style grid
    Object.keys(eventsByDate).forEach(dateKey => {
      const events = eventsByDate[dateKey];
      const date = new Date(dateKey);
      const formattedDate = date.toLocaleDateString('en-US', { 
        weekday: 'short', 
        month: 'short', 
        day: 'numeric',
        year: 'numeric'
      });
      
      const dateCard = document.createElement('div');
      dateCard.className = 'col-md-6 col-lg-4';
      
      dateCard.innerHTML = `
        <div class="card h-100" style="background-color: rgba(255, 255, 255, 0.05); border-color: rgba(255, 255, 255, 0.1);">
          <div class="card-header" style="background-color: rgba(0, 0, 0, 0.3);">
            <h6 class="mb-0"><i class="bi bi-calendar3"></i> ${formattedDate}</h6>
          </div>
          <div class="card-body">
            ${events.map(event => {
              // Parse ISO datetime strings from API response (format: "2025-12-02T19:00:00+05:00")
              const startTimeStr = typeof event.start === 'string' ? event.start : (event.start?.dateTime || event.start?.date || '');
              const endTimeStr = typeof event.end === 'string' ? event.end : (event.end?.dateTime || event.end?.date || '');
              const startDate = startTimeStr ? new Date(startTimeStr) : new Date();
              const endDate = endTimeStr ? new Date(endTimeStr) : new Date();
              const formattedStartTime = startDate.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
              });
              const formattedEndTime = endDate.toLocaleTimeString('en-US', { 
                hour: '2-digit', 
                minute: '2-digit' 
              });
              
              // Format attendees
              const attendeesList = event.attendees && event.attendees.length > 0 
                ? event.attendees.map(a => a.email || (typeof a === 'string' ? a : a.displayName || 'Unknown')).join(', ')
                : '';
              
              // Format organizer
              const organizer = event.organizer ? (event.organizer.email || event.organizer.displayName || '') : '';
              
              // Check if recurring
              const isRecurring = event.recurrence && event.recurrence.length > 0;
              
              return `
                <div class="mb-3 pb-3 border-bottom" style="border-color: rgba(255, 255, 255, 0.1) !important;">
                  <div class="fw-semibold mb-1">
                    ${escapeHtml(event.summary || 'Untitled Event')}
                    ${isRecurring ? '<span class="badge bg-info ms-1" style="font-size: 0.7rem;">Recurring</span>' : ''}
                  </div>
                  <div class="small text-muted mb-2">
                    <i class="bi bi-clock"></i> ${formattedStartTime} - ${formattedEndTime}
                  </div>
                  ${event.description ? `<div class="small mb-2">${escapeHtml(event.description.substring(0, 100))}${event.description.length > 100 ? '...' : ''}</div>` : ''}
                  ${event.location ? `<div class="small text-muted mb-1"><i class="bi bi-geo-alt"></i> ${escapeHtml(event.location)}</div>` : ''}
                  ${organizer ? `<div class="small text-muted mb-1"><i class="bi bi-person"></i> ${escapeHtml(organizer)}</div>` : ''}
                  ${event.hangoutLink ? `<a href="${event.hangoutLink}" target="_blank" class="btn btn-sm btn-primary mt-1"><i class="bi bi-camera-video"></i> Join</a>` : ''}
                  ${event.htmlLink ? `<a href="${event.htmlLink}" target="_blank" class="btn btn-sm btn-outline-secondary mt-1 ms-1"><i class="bi bi-calendar-check"></i> View</a>` : ''}
                </div>
              `;
            }).join('')}
          </div>
        </div>
      `;
      
      calendarViewEl.appendChild(dateCard);
    });
    
  } catch (error) {
    loadingEl.style.display = 'none';
    errorEl.textContent = 'Failed to load events. Please try again later.';
    errorEl.style.display = 'block';
    console.error('Error fetching calendar events:', error);
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}
</script>
{% endblock %}

{% block content %}
  <div class="container py-2">
    <div class="row justify-content-center">
      <div class="col-lg-12">
        <div class="card shadow-sm border-0">
          <div class="card-header bg-white border-0 pt-4 pb-3">
            <h2 class="text-center mb-2">CIM Questions</h2>
            <p class="text-center text-muted mb-0">Please fill out the information below to generate your analysis</p>
          </div>
          
          <div class="card-body p-4 p-md-5">
            {% if error %}
            <div class="alert alert-danger alert-dismissible fade show" role="alert">
              {{ error }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}
            {% if success %}
            <div class="alert alert-success alert-dismissible fade show" role="alert">
              {{ success }}
              <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            </div>
            {% endif %}


            <form method="POST" action="/submit-cim" enctype="multipart/form-data">
              
              <!-- Personal Information Section -->
              <div class="mb-5">
                <h5 class="border-bottom pb-2 mb-4">Personal Information</h5>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="full_name" class="form-label fw-semibold">Full Name</label>
                    <input type="text" class="form-control form-control-lg" id="full_name" name="full_name" required value="{{ form_data.full_name if form_data else '' }}">
                  </div>
                  <div class="col-md-6">
                    <label for="email" class="form-label fw-semibold">Email</label>
                    <input type="email" class="form-control form-control-lg" id="email" name="email" required value="{{ form_data.email if form_data else '' }}">
                  </div>
                </div>
              </div>

              <!-- Business Details Section -->
              <div class="mb-5">
                <h5 class="border-bottom pb-2 mb-4">Business Details</h5>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="industry" class="form-label fw-semibold">Industry</label>
                    <input type="text" class="form-control form-control-lg" id="industry" name="industry"  value="{{ form_data.industry if form_data else '' }}">
                  </div>
                  <div class="col-md-6">
                    <label for="location" class="form-label fw-semibold">Location</label>
                    <input type="text" class="form-control form-control-lg" id="location" name="location"  value="{{ form_data.location if form_data else '' }}">
                  </div>
                </div>
              </div>

              <!-- Financial Information Section -->
              <div class="mb-5">
                <h5 class="border-bottom pb-2 mb-4">Financial Information</h5>
                <div class="row g-3">
                  <div class="col-md-3">
                    <label for="purchase_price" class="form-label fw-semibold">Purchase Price</label>
                    <div class="input-group input-group-lg">
                      <span class="input-group-text">$</span>
                      <input type="number" class="form-control" id="purchase_price" name="purchase_price" min="0" step="any"  value="{{ form_data.purchase_price if form_data else '' }}">
                    </div>
                  </div>
                  <div class="col-md-3">
                    <label for="revenue" class="form-label fw-semibold">Revenue</label>
                    <div class="input-group input-group-lg">
                      <span class="input-group-text">$</span>
                      <input type="number" class="form-control" id="revenue" name="revenue" min="0" step="any"  value="{{ form_data.revenue if form_data else '' }}">
                    </div>
                  </div>
                  <div class="col-md-3">
                    <label for="avg_sde" class="form-label fw-semibold">Avg SDE</label>
                    <div class="input-group input-group-lg">
                      <span class="input-group-text">$</span>
                      <input type="number" class="form-control" id="avg_sde" name="avg_sde" min="0" step="any"  value="{{ form_data.avg_sde if form_data else '' }}">
                    </div>
                  </div>
                  <div class="col-md-3">
                    <label for="total_adjustments" class="form-label fw-semibold">Total $ Adjustments</label>
                    <div class="input-group input-group-lg">
                      <span class="input-group-text">$</span>
                      <input type="number" class="form-control" id="total_adjustments" name="total_adjustments" min="0" step="any"  value="{{ form_data.total_adjustments if form_data else '' }}">
                    </div>
                  </div>
                </div>
              </div>

              <!-- Deal Information Section -->
              <div class="mb-5">
                <h5 class="border-bottom pb-2 mb-4">Deal Information</h5>
                <div class="row g-3">
                  <div class="col-md-6">
                    <label for="seller_role" class="form-label fw-semibold">Seller Role</label>
                    <input type="text" class="form-control form-control-lg" id="seller_role" name="seller_role"  value="{{ form_data.seller_role if form_data else '' }}">
                  </div>
                  <div class="col-md-6">
                    <label for="reason_for_selling" class="form-label fw-semibold">Reason for Selling</label>
                    <input type="text" class="form-control form-control-lg" id="reason_for_selling" name="reason_for_selling"  value="{{ form_data.reason_for_selling if form_data else '' }}">
                  </div>
                </div>
                
                <div class="row g-3 mt-1">
                  <div class="col-md-12">
                    <label for="owner_involvement" class="form-label fw-semibold">Owner Involvement (high-level role description, hours per week, etc.)</label>
                    <textarea class="form-control" id="owner_involvement" name="owner_involvement" rows="3">{{ form_data.owner_involvement if form_data else '' }}</textarea>
                  </div>
                </div>

                <div class="row g-3 mt-1">
                  <div class="col-md-4">
                    <label for="gm_in_place" class="form-label fw-semibold">GM in Place?</label>
                    <select class="form-select form-select-lg" id="gm_in_place" name="gm_in_place">
                      <option value="">Select...</option>
                      <option value="Yes" {{ 'selected' if form_data and form_data.gm_in_place == 'Yes' else '' }}>Yes</option>
                      <option value="No" {{ 'selected' if form_data and form_data.gm_in_place == 'No' else '' }}>No</option>
                    </select>
                  </div>
                  <div class="col-md-4">
                    <label for="tenure_of_gm" class="form-label fw-semibold">Tenure of GM (if applicable)</label>
                    <input type="text" class="form-control form-control-lg" id="tenure_of_gm" name="tenure_of_gm"  value="{{ form_data.tenure_of_gm if form_data else '' }}">
                  </div>
                  <div class="col-md-4">
                    <label for="number_of_employees" class="form-label fw-semibold">Number of Employees</label>
                    <input type="number" class="form-control form-control-lg" id="number_of_employees" name="number_of_employees" min="0"  value="{{ form_data.number_of_employees if form_data else '' }}">
                  </div>
                </div>
              </div>

              <!-- Additional Questions Section -->
              <div class="mb-5">
                <h5 class="border-bottom pb-2 mb-4">Additional Questions</h5>
                
                <div class="mb-4">
                  <label for="cim_search_narrative_fit" class="form-label fw-semibold">Does the CIM fit your Search Narrative & your Search Narrative Question Guide?</label>
                  <select class="form-select form-select-lg" id="cim_search_narrative_fit" name="cim_search_narrative_fit" onchange="toggleSearchNarrative()">
                    <option value="">Select...</option>
                    <option value="Yes" {{ 'selected' if form_data and form_data.cim_search_narrative_fit == 'Yes' else '' }}>Yes</option>
                    <option value="No" {{ 'selected' if form_data and form_data.cim_search_narrative_fit == 'No' else '' }}>No</option>
                  </select>
                </div>

                <div class="mb-4" id="search_narrative_section" style="display: {{ 'block' if form_data and form_data.cim_search_narrative_fit == 'Yes' else 'none' }};">
                  <label for="search_narrative_relation" class="form-label fw-semibold">How does this relate to your search narrative?</label>
                  <textarea class="form-control" id="search_narrative_relation" name="search_narrative_relation" rows="4">{{ form_data.search_narrative_relation if form_data else '' }}</textarea>
                </div>

                <div class="mb-4">
                  <label for="deal_likes_dislikes" class="form-label fw-semibold">What do you like/don't like about the deal?</label>
                  <textarea class="form-control" id="deal_likes_dislikes" name="deal_likes_dislikes" rows="4" >{{ form_data.deal_likes_dislikes if form_data else '' }}</textarea>
                </div>

                <div class="mb-4">
                  <label for="deal_questions_concerns" class="form-label fw-semibold">What questions/concerns do you have about the deal?</label>
                  <textarea class="form-control" id="deal_questions_concerns" name="deal_questions_concerns" rows="4">{{ form_data.deal_questions_concerns if form_data else '' }}</textarea>
                </div>
              </div>

              <!-- File Upload Section -->
              <div class="mb-5">
                <h5 class="border-bottom pb-2 mb-4">Documents</h5>
                <div class="mb-3">
                  <label for="files" class="form-label fw-semibold">Upload all files that help us review your deal here</label>
                  <input type="file" class="form-control form-control-lg" id="files" name="files" multiple>
                  <div class="form-text">You can upload multiple files (PDF, Excel, Word, etc.)</div>
                </div>
              </div>

              <!-- Terms and Conditions -->
              <div class="mb-4">
                <div class="card bg-light border-0">
                  <div class="card-body">
                    <div class="form-check">
                      <input class="form-check-input" type="checkbox" id="terms_accepted" name="terms_accepted" required>
                      <label class="form-check-label" for="terms_accepted">
                        <strong>Confirm terms and conditions:</strong> This data can be reviewed live on a call with others. We do not take any responsibility for it.
                      </label>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Schedule Live Call Button -->
              <div class="mb-4">
                <button type="button" class="btn btn-primary rounded-pill btn-lg px-5 w-100" id="scheduleCallBtn" onclick="handleScheduleCall(event)" style="opacity: 0.6; cursor: not-allowed;">
                  ðŸ“… Schedule a Live Call
                </button>
                <small class="text-muted d-block mt-2">Please enter your email above to schedule a call</small>
              </div>

            

              <!-- Action Buttons -->
              <div class="d-flex gap-3 justify-content-between flex-wrap">
                <a href="/" class="btn btn-outline-secondary rounded-pill btn-lg px-5">Back to Home</a>
                <button type="submit" class="btn submit-btn rounded-pill btn-lg px-5">Submit Information</button>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </div>

{% endblock %}

<script>
// All functions are defined in head block, just define toggleSearchNarrative here

function toggleSearchNarrative() {
  const select = document.getElementById('cim_search_narrative_fit');
  const section = document.getElementById('search_narrative_section');
  
  if (select.value === 'Yes') {
    section.style.display = 'block';
  } else {
    section.style.display = 'none';
  }
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
  toggleSearchNarrative();
  
  // Enable/disable Schedule Call button based on email input
  const emailInput = document.getElementById('email');
  const scheduleBtn = document.getElementById('scheduleCallBtn');
  
  if (emailInput && scheduleBtn) {
    function updateScheduleButton() {
      const email = emailInput.value.trim();
      const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
      
      if (email && emailPattern.test(email)) {
        scheduleBtn.style.opacity = '1';
        scheduleBtn.style.cursor = 'pointer';
        scheduleBtn.parentElement.querySelector('small').style.display = 'none';
      } else {
        scheduleBtn.style.opacity = '0.6';
        scheduleBtn.style.cursor = 'not-allowed';
        scheduleBtn.parentElement.querySelector('small').style.display = 'block';
      }
    }
    
    // Check on page load
    updateScheduleButton();
    
    // Check on input change
    emailInput.addEventListener('input', updateScheduleButton);
    emailInput.addEventListener('blur', updateScheduleButton);
  }
  
  // Scroll to top if success message is present
  const successAlert = document.querySelector('.alert-success');
  if (successAlert) {
    window.scrollTo({ top: 0, behavior: 'smooth' });
    setTimeout(function() {
      if (typeof bootstrap !== 'undefined') {
        const alert = bootstrap.Alert.getOrCreateInstance(successAlert);
        alert.close();
      }
    }, 10000);
  }
});
</script>