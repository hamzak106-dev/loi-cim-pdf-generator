{% extends "base.html" %}

{% block title %}Schedule a Live Call{% endblock %}

{% block scripts %}
<style>
.custom-calendar {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
  background-color: rgba(255, 255, 255, 0.05);
  background-image: radial-gradient(circle at bottom right, rgba(13, 56, 114, 0.9), transparent 70%);
  background-blend-mode: screen;
  backdrop-filter: blur(12px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  border-radius: 8px;
  overflow: hidden;
}

.calendar-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 15px 20px;
  background: linear-gradient(135deg, rgba(13, 56, 114, 0.9) 0%, rgba(26, 90, 158, 0.9) 100%);
  color: #fff;
  border-radius: 8px 8px 0 0;
}

.calendar-nav-btn {
  background: rgba(255, 255, 255, 0.2);
  border: 1px solid rgba(255, 255, 255, 0.3);
  color: #fff;
  padding: 8px 15px;
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.3s;
}

.calendar-nav-btn:hover {
  background: rgba(255, 255, 255, 0.3);
  border-color: rgba(255, 255, 255, 0.5);
}

.calendar-month-year {
  font-size: 1.2rem;
  font-weight: 600;
  color: #fff;
}

.calendar-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 5px;
  padding: 10px;
  background-color: rgba(0, 0, 0, 0.3);
  border-bottom: 1px solid rgba(255, 255, 255, 0.1);
}

.calendar-weekday {
  text-align: center;
  font-weight: 600;
  color: rgba(255, 255, 255, 0.8);
  font-size: 0.85rem;
  padding: 8px;
}

.calendar-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  gap: 5px;
  padding: 10px;
  background-color: transparent;
}

.calendar-day {
  min-height: 80px;
  display: flex;
  flex-direction: column;
  align-items: flex-start;
  justify-content: flex-start;
  border: 1px solid rgba(255, 255, 255, 0.2);
  border-radius: 5px;
  cursor: pointer;
  transition: all 0.2s;
  background-color: rgba(255, 255, 255, 0.05);
  color: #fff;
  font-size: 0.9rem;
  padding: 5px;
  position: relative;
}

.calendar-day:hover {
  background-color: rgba(13, 56, 114, 0.3);
  border-color: rgba(13, 56, 114, 0.8);
  color: #fff;
}

.calendar-day.other-month {
  color: rgba(255, 255, 255, 0.3);
  background-color: rgba(255, 255, 255, 0.02);
}

.calendar-day.today {
  background-color: rgba(13, 56, 114, 0.8);
  color: #fff;
  font-weight: 600;
  border-color: rgba(13, 56, 114, 1);
}

.calendar-day.has-event {
  background-color: rgba(255, 193, 7, 0.15);
  border-color: rgba(255, 193, 7, 0.5);
}

.calendar-day.selected {
  background-color: rgba(13, 56, 114, 0.9);
  color: #fff;
  border-color: rgba(13, 56, 114, 1);
  font-weight: 600;
}

.day-number {
  font-weight: 600;
  margin-bottom: 2px;
}

.day-events {
  width: 100%;
  margin-top: 2px;
  font-size: 0.7rem;
}

.day-event-item {
  background-color: rgba(13, 56, 114, 0.6);
  color: #fff;
  padding: 2px 4px;
  margin: 2px 0;
  border-radius: 3px;
  cursor: pointer;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
  transition: all 0.2s;
}

.day-event-item:hover {
  background-color: rgba(13, 56, 114, 0.9);
  transform: scale(1.02);
}

.calendar-events {
  padding: 15px;
  max-height: 400px;
  overflow-y: auto;
  border-top: 1px solid rgba(255, 255, 255, 0.1);
  margin-top: 20px;
  background-color: rgba(255, 255, 255, 0.03);
  border-radius: 0 0 8px 8px;
}

.event-item {
  padding: 12px;
  margin-bottom: 10px;
  background-color: rgba(255, 255, 255, 0.05);
  border-left: 3px solid rgba(13, 56, 114, 0.9);
  border-radius: 4px;
  cursor: pointer;
  transition: all 0.2s;
}

.event-item:hover {
  background-color: rgba(255, 255, 255, 0.1);
  transform: translateX(5px);
}

.event-time {
  font-size: 0.85rem;
  color: rgba(255, 255, 255, 0.7);
  font-weight: 600;
}

.event-title {
  font-weight: 500;
  color: #fff;
  margin-top: 3px;
}

.no-events {
  text-align: center;
  padding: 20px;
  color: rgba(255, 255, 255, 0.6);
}

/* Event Detail Modal Styles */
.event-modal {
  display: none;
  position: fixed;
  z-index: 1050;
  left: 0;
  top: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.6);
  backdrop-filter: blur(4px);
}

.event-modal.show {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
}

.event-modal-content {
  background-color: #fff;
  margin: auto;
  border-radius: 16px;
  width: 100%;
  max-width: 600px;
  max-height: 90vh;
  overflow: hidden;
  box-shadow: 0 20px 60px rgba(0, 0, 0, 0.4);
  animation: modalSlideIn 0.3s ease-out;
  display: flex;
  flex-direction: column;
}

@keyframes modalSlideIn {
  from {
    opacity: 0;
    transform: translateY(-30px) scale(0.95);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

.event-modal-header {
  background: linear-gradient(135deg, #0d3872 0%, #1a5a9e 100%);
  
  color: #fff;
  padding: 30px 35px 25px;
  position: relative;
  border-radius: 16px 16px 0 0;
}

.event-modal-title {
  font-size: 1.5rem;
  font-weight: 700;
  margin: 0 0 8px 0;
  line-height: 1.3;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: #fff;
}

.event-modal-subtitle {
  font-size: 0.95rem;
  opacity: 0.95;
  margin: 0;
  font-weight: 500;
  display: flex;
  align-items: center;
  gap: 8px;
}

.event-modal-subtitle::before {
  content: 'A';
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  background-color: rgba(255, 255, 255, 0.2);
  border-radius: 4px;
  font-weight: 700;
  font-size: 0.9rem;
}

.event-modal-close {
  position: absolute;
  top: 20px;
  right: 20px;
  background: transparent;
  border: none;
  color: rgba(255, 255, 255, 0.8);
  font-size: 1.8rem;
  width: 40px;
  height: 40px;
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s;
  line-height: 1;
  padding: 0;
}

.event-modal-close:hover {
  background: rgba(255, 255, 255, 0.15);
  color: #fff;
  transform: rotate(90deg);
}

.event-modal-body {
  padding: 30px 35px;
  color: #333;
  overflow-y: auto;
  flex: 1;
}

.event-detail-item {
  margin-bottom: 24px;
  display: flex;
  align-items: flex-start;
  gap: 16px;
}

.event-detail-icon {
  font-size: 1.4rem;
  margin-top: 2px;
  min-width: 32px;
  height: 32px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.event-detail-content {
  flex: 1;
}

.event-detail-label {
  font-size: 0.75rem;
  color: #666;
  margin-bottom: 6px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 1px;
}

.event-detail-value {
  font-size: 0.95rem;
  color: #333;
  line-height: 1.6;
  font-weight: 400;
}

.event-detail-value a {
  color: rgba(13, 56, 114, 0.9);
  text-decoration: none;
  word-break: break-all;
}

.event-detail-value a:hover {
  text-decoration: underline;
}

.event-description {
  white-space: pre-wrap;
  line-height: 1.6;
}

.event-attendees-list {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  margin-top: 8px;
}

.event-attendee-badge {
  background-color: #f5f5f5;
  color: #333;
  padding: 8px 14px;
  border-radius: 20px;
  font-size: 0.85rem;
  display: inline-flex;
  align-items: center;
  gap: 5px;
  border: 1px solid #e0e0e0;
  font-weight: 400;
}

.event-attendee-badge.organizer {
  background-color: #e3f2fd;
  color: #1976d2;
  border-color: #90caf9;
  font-weight: 500;
}

.event-modal-footer {
  padding: 25px 35px;
  border-top: 1px solid #eee;
  display: flex;
  gap: 12px;
  justify-content: flex-end;
  background-color: #fafafa;
}

.btn-add-calendar {
  background: linear-gradient(135deg, #0d3872 0%, #1a5a9e 100%);
  color: #fff;
  border: none;
  padding: 14px 28px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.95rem;
  cursor: pointer;
  display: inline-flex;
  align-items: center;
  gap: 10px;
  transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(13, 56, 114, 0.2);
}

.btn-add-calendar:hover {
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(13, 56, 114, 0.3);
}

.btn-add-calendar:active {
  transform: translateY(0);
}

.btn-join-meeting {
  background-color: #0d3872;
  color: #fff;
  border: none;
  padding: 14px 28px;
  border-radius: 8px;
  font-weight: 600;
  font-size: 0.95rem;
  cursor: pointer;
  text-decoration: none;
  display: inline-flex;
  align-items: center;
  gap: 10px;
  transition: all 0.2s;
  box-shadow: 0 2px 8px rgba(13, 56, 114, 0.2);
}

.btn-join-meeting:hover {
  background-color: #0a2d5a;
  transform: translateY(-2px);
  box-shadow: 0 4px 12px rgba(13, 56, 114, 0.3);
  color: #fff;
  text-decoration: none;
}

.btn-join-meeting:active {
  transform: translateY(0);
}

/* Email Input Modal Styles */
#emailInputModal {
  z-index: 1055 !important;
}

#emailInputModal .modal-dialog {
  z-index: 1056 !important;
}

#emailInputModal .modal-content {
  background-color: rgba(5, 13, 30, 0.98) !important;
  color: #fff !important;
  border: 1px solid rgba(255, 255, 255, 0.3) !important;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.5) !important;
}

#emailInputModal .modal-header {
  border-bottom: 1px solid rgba(255, 255, 255, 0.2) !important;
}

#emailInputModal .modal-footer {
  border-top: 1px solid rgba(255, 255, 255, 0.2) !important;
}

#emailInputModal .form-control {
  background-color: rgba(255, 255, 255, 0.1) !important;
  border: 1px solid rgba(255, 255, 255, 0.2) !important;
  color: #fff !important;
}

#emailInputModal .form-control:focus {
  background-color: rgba(255, 255, 255, 0.15) !important;
  border-color: rgba(13, 56, 114, 0.8) !important;
  color: #fff !important;
  box-shadow: 0 0 0 0.25rem rgba(13, 56, 114, 0.25) !important;
}

#emailInputModal .form-control::placeholder {
  color: rgba(255, 255, 255, 0.5) !important;
}

#emailInputModal .btn-secondary {
  background-color: rgba(255, 255, 255, 0.1) !important;
  border-color: rgba(255, 255, 255, 0.3) !important;
  color: #fff !important;
}

#emailInputModal .btn-secondary:hover {
  background-color: rgba(255, 255, 255, 0.2) !important;
  border-color: rgba(255, 255, 255, 0.5) !important;
}

.email-modal-backdrop {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.7);
  z-index: 1050;
  backdrop-filter: blur(5px);
}

/* Full Screen Loader Styles */
.calendar-loader {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background-color: rgba(0, 0, 0, 0.75);
  backdrop-filter: blur(8px);
  z-index: 9999;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  color: #fff;
  transition: opacity 0.3s ease;
}

.calendar-loader.show {
  display: flex;
}

.calendar-loader .spinner-border {
  width: 4rem;
  height: 4rem;
  border-width: 0.4rem;
  margin-bottom: 20px;
  border-color: rgba(255, 255, 255, 0.2);
  border-right-color: #fff;
  animation: spinner-border 0.75s linear infinite;
}

.calendar-loader-text {
  font-size: 1.1rem;
  font-weight: 500;
  margin-top: 15px;
  color: #fff;
}

@keyframes spinner-border {
  to {
    transform: rotate(360deg);
  }
}

.calendar-content {
  opacity: 0;
  transition: opacity 0.4s ease-in;
}

.calendar-content.loaded {
  opacity: 1;
}
</style>
<script>
// Custom Calendar Component
class CustomCalendar {
  constructor(containerId, options = {}) {
    this.container = document.getElementById(containerId);
    this.currentDate = options.initialDate || new Date();
    this.selectedDate = null;
    this.events = options.events || [];
    this.onDateSelect = options.onDateSelect || null;
    this.onEventClick = options.onEventClick || null;
    this.formType = options.formType || 'LOI Call';
    this.host = options.host || 'Evan';
    
    this.monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 
                      'July', 'August', 'September', 'October', 'November', 'December'];
    this.weekdayNames = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
    
    this.render();
  }
  
  render() {
    const year = this.currentDate.getFullYear();
    const month = this.currentDate.getMonth();
    
    let html = `
      <div class="calendar-header">
        <button class="calendar-nav-btn" onclick="window.calendarInstance.prevMonth()">‚Äπ Prev</button>
        <div class="calendar-month-year">${this.monthNames[month]} ${year}</div>
        <button class="calendar-nav-btn" onclick="window.calendarInstance.nextMonth()">Next ‚Ä∫</button>
      </div>
      <div class="calendar-weekdays">
        ${this.weekdayNames.map(day => `<div class="calendar-weekday">${day}</div>`).join('')}
      </div>
      <div class="calendar-days">
        ${this.renderDays()}
      </div>
    `;
    
    this.container.innerHTML = html;
    this.attachDayClickListeners();
  }
  
  renderDays() {
    const year = this.currentDate.getFullYear();
    const month = this.currentDate.getMonth();
    
    const firstDay = new Date(year, month, 1);
    const lastDay = new Date(year, month + 1, 0);
    const daysInMonth = lastDay.getDate();
    const startingDayOfWeek = firstDay.getDay();
    
    const today = new Date();
    const isToday = (date) => {
      return date.getDate() === today.getDate() &&
             date.getMonth() === today.getMonth() &&
             date.getFullYear() === today.getFullYear();
    };
    
    const getEventsForDate = (date) => {
      return this.events.filter(event => {
        const startTime = typeof event.start === 'string' ? event.start : (event.start?.dateTime || event.start?.date);
        if (!startTime) return false;
        const eventDate = new Date(startTime);
        return eventDate.getDate() === date.getDate() &&
               eventDate.getMonth() === date.getMonth() &&
               eventDate.getFullYear() === date.getFullYear();
      });
    };
    
    let days = [];
    
    // Previous month's days
    const prevMonth = new Date(year, month, 0);
    const prevMonthDays = prevMonth.getDate();
    for (let i = startingDayOfWeek - 1; i >= 0; i--) {
      const date = new Date(year, month - 1, prevMonthDays - i);
      days.push(`<div class="calendar-day other-month" data-date="${date.toISOString()}">
        <div class="day-number">${prevMonthDays - i}</div>
      </div>`);
    }
    
    // Current month's days
    for (let day = 1; day <= daysInMonth; day++) {
      const date = new Date(year, month, day);
      const classes = ['calendar-day'];
      if (isToday(date)) classes.push('today');
      
      const dayEvents = getEventsForDate(date);
      if (dayEvents.length > 0) classes.push('has-event');
      
      if (this.selectedDate && 
          this.selectedDate.getDate() === date.getDate() &&
          this.selectedDate.getMonth() === date.getMonth() &&
          this.selectedDate.getFullYear() === date.getFullYear()) {
        classes.push('selected');
      }
      
      const eventsHtml = dayEvents.length > 0 ? `
        <div class="day-events">
          ${dayEvents.slice(0, 3).map((event, idx) => {
            const startTime = typeof event.start === 'string' ? event.start : (event.start?.dateTime || event.start?.date);
            const eventTime = startTime ? new Date(startTime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : '';
            const title = event.summary || 'Untitled Event';
            return `<div class="day-event-item" data-event-id="${event.id}" data-event-index="${year}-${month}-${day}-${idx}" onclick="event.stopPropagation(); const eventData = window.calendarInstance.events.find(e => e.id === '${event.id}'); if(eventData) window.showEventDetails(eventData);">${eventTime} - ${escapeHtml(title.substring(0, 20))}${title.length > 20 ? '...' : ''}</div>`;
          }).join('')}
          ${dayEvents.length > 3 ? `<div class="day-event-item" style="opacity: 0.7;">+${dayEvents.length - 3} more</div>` : ''}
        </div>
      ` : '';
      
      days.push(`<div class="${classes.join(' ')}" data-date="${date.toISOString()}">
        <div class="day-number">${day}</div>
        ${eventsHtml}
      </div>`);
    }
    
    // Next month's days
    const remainingCells = 42 - days.length;
    for (let day = 1; day <= remainingCells; day++) {
      const date = new Date(year, month + 1, day);
      days.push(`<div class="calendar-day other-month" data-date="${date.toISOString()}">
        <div class="day-number">${day}</div>
      </div>`);
    }
    
    return days.join('');
  }
  
  attachDayClickListeners() {
    const dayElements = this.container.querySelectorAll('.calendar-day:not(.other-month)');
    dayElements.forEach(dayEl => {
      dayEl.addEventListener('click', (e) => {
        if (e.target.closest('.day-event-item')) return; // Don't trigger if clicking on event
        const dateStr = dayEl.getAttribute('data-date');
        const date = new Date(dateStr);
        this.selectDate(date);
      });
    });
  }
  
  selectDate(date) {
    this.selectedDate = date;
    this.render();
    
    if (this.onDateSelect) {
      const dayEvents = this.getEventsForDate(date);
      this.onDateSelect(date, dayEvents);
    }
  }
  
  getEventsForDate(date) {
    return this.events.filter(event => {
      const startTime = typeof event.start === 'string' ? event.start : (event.start?.dateTime || event.start?.date);
      if (!startTime) return false;
      const eventDate = new Date(startTime);
      return eventDate.getDate() === date.getDate() &&
             eventDate.getMonth() === date.getMonth() &&
             eventDate.getFullYear() === date.getFullYear();
    });
  }
  
  prevMonth() {
    this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() - 1, 1);
    this.render();
  }
  
  nextMonth() {
    this.currentDate = new Date(this.currentDate.getFullYear(), this.currentDate.getMonth() + 1, 1);
    this.render();
  }
  
  setEvents(events) {
    this.events = events;
    this.render();
  }
}

function escapeHtml(text) {
  const div = document.createElement('div');
  div.textContent = text;
  return div.innerHTML;
}

// Show event details in modal
function showEventDetails(event) {
  const modal = document.getElementById('eventDetailModal');
  if (!modal) {
    // Create modal if it doesn't exist
    const modalHtml = `
      <div id="eventDetailModal" class="event-modal bg-dark">
        <div class="event-modal-content">
          <div class="event-modal-header">
            <button class="event-modal-close" onclick="closeEventModal()">&times;</button>
            <h2 class="event-modal-title" id="modalEventTitle"></h2>
            <p class="event-modal-subtitle" id="modalEventSubtitle"></p>
          </div>
          <div class="event-modal-body" id="modalEventBody"></div>
          <div class="event-modal-footer" id="modalEventFooter"></div>
        </div>
      </div>
    `;
    document.body.insertAdjacentHTML('beforeend', modalHtml);
  }
  
  const modalEl = document.getElementById('eventDetailModal');
  const titleEl = document.getElementById('modalEventTitle');
  const subtitleEl = document.getElementById('modalEventSubtitle');
  const bodyEl = document.getElementById('modalEventBody');
  const footerEl = document.getElementById('modalEventFooter');
  
  // Parse event times - handle both string format (legacy) and object format (new)
  let startTime, endTime;
  if (typeof event.start === 'string') {
    // Legacy format: event.start is a string
    startTime = event.start;
    endTime = typeof event.end === 'string' ? event.end : (event.end?.dateTime || event.end?.date);
  } else {
    // New format: event.start is an object with dateTime/date and timeZone
    startTime = event.start?.dateTime || event.start?.date;
    endTime = event.end?.dateTime || event.end?.date;
  }
  
  const startDate = startTime ? new Date(startTime) : null;
  const endDate = endTime ? new Date(endTime) : null;
  
  // Get timezone from the event (from Google Calendar)
  const eventTimezone = (typeof event.start === 'object' && event.start?.timeZone) || null;
  
  // Function to convert timezone to full name (e.g., "Eastern Time" instead of "ET")
  function getTimezoneFullName(timezoneName, date) {
    // First, try to map timezone names directly to full names
    const timezoneMap = {
      'Asia/Karachi': 'Pakistan Standard Time',
      'Asia/Kolkata': 'India Standard Time',
      'Asia/Dubai': 'Gulf Standard Time',
      'Asia/Singapore': 'Singapore Standard Time',
      'Asia/Tokyo': 'Japan Standard Time',
      'Asia/Shanghai': 'China Standard Time',
      'Asia/Hong_Kong': 'Hong Kong Time',
      'Asia/Dhaka': 'Bangladesh Standard Time',
      'America/New_York': 'Eastern Time',
      'America/Chicago': 'Central Time',
      'America/Denver': 'Mountain Time',
      'America/Los_Angeles': 'Pacific Time',
      'America/Toronto': 'Eastern Time',
      'Europe/London': 'Greenwich Mean Time',
      'Europe/Paris': 'Central European Time',
      'Europe/Moscow': 'Moscow Standard Time',
      'Europe/Berlin': 'Central European Time',
      'Australia/Sydney': 'Australian Eastern Standard Time',
      'Australia/Melbourne': 'Australian Eastern Standard Time',
    };
    
    if (timezoneName && timezoneMap[timezoneName]) {
      return timezoneMap[timezoneName];
    }
    
    // If timezone name not found, try to get full name from Intl API
    if (timezoneName) {
      try {
        // Try to get long timezone name
        const formatter = new Intl.DateTimeFormat('en-US', { 
          timeZone: timezoneName,
          timeZoneName: 'long' 
        });
        const parts = formatter.formatToParts(date || startDate);
        const tzPart = parts.find(part => part.type === 'timeZoneName');
        if (tzPart) {
          let tzName = tzPart.value;
          // If it's GMT+5 format, convert to full name
          if (tzName.startsWith('GMT')) {
            // Extract offset (e.g., GMT+5, GMT+05, GMT+5:30)
            const offsetMatch = tzName.match(/GMT([+-])(\d{1,2})(:?(\d{2}))?/);
            if (offsetMatch) {
              const sign = offsetMatch[1];
              const hours = parseInt(offsetMatch[2]);
              const offsetKey = `${sign}${hours}${minutes > 0 ? ':' + String(minutes).padStart(2, '0') : ''}`;
              const offsetKeyAlt = `${sign}${String(hours).padStart(2, '0')}${minutes > 0 ? ':' + String(minutes).padStart(2, '0') : ''}`;
              
              // Map offsets to full timezone names
              const offsetToTz = {
                '+5': 'Pakistan Standard Time', '+05': 'Pakistan Standard Time',
                '+5:30': 'India Standard Time', '+05:30': 'India Standard Time',
                '+6': 'Bangladesh Standard Time', '+06': 'Bangladesh Standard Time',
                '+8': 'China Standard Time', '+08': 'China Standard Time',
                '+9': 'Japan Standard Time', '+09': 'Japan Standard Time',
                '+10': 'Australian Eastern Standard Time', '+11': 'Australian Eastern Daylight Time',
                '-5': 'Eastern Time', '-05': 'Eastern Time',
                '-6': 'Central Time', '-06': 'Central Time',
                '-7': 'Mountain Time', '-07': 'Mountain Time',
                '-8': 'Pacific Time', '-08': 'Pacific Time',
                '-9': 'Alaska Standard Time', '-09': 'Alaska Standard Time',
                '-10': 'Hawaii Standard Time',
                '+0': 'Greenwich Mean Time', '+00': 'Greenwich Mean Time',
                '+1': 'Central European Time', '+01': 'Central European Time',
                '+2': 'Eastern European Time', '+02': 'Eastern European Time',
                '+3': 'Moscow Standard Time', '+03': 'Moscow Standard Time',
                '+4': 'Gulf Standard Time', '+04': 'Gulf Standard Time',
              };
              
              return offsetToTz[offsetKey] || offsetToTz[offsetKeyAlt] || tzName;
            }
            // If no match, return as is
            return tzName;
          }
          // If it's already a full name, return it
          return tzName;
        }
      } catch (e) {
        console.error('Error getting timezone full name:', e);
      }
    }
    
    // Fallback: try to extract from date string offset
    if (startTime && (startTime.includes('+') || startTime.includes('-'))) {
      const tzMatch = startTime.match(/([+-]\d{2}):?(\d{2})?$/);
      if (tzMatch) {
        const sign = tzMatch[1][0];
        const hours = parseInt(tzMatch[1].substring(1));
        const minutes = tzMatch[2] ? parseInt(tzMatch[2]) : 0;
        const offsetKey = `${sign}${hours}${minutes > 0 ? ':' + String(minutes).padStart(2, '0') : ''}`;
        const offsetKeyAlt = `${sign}${String(hours).padStart(2, '0')}${minutes > 0 ? ':' + String(minutes).padStart(2, '0') : ''}`;
        
        const offsetToTz = {
          '+5': 'Pakistan Standard Time', '+05': 'Pakistan Standard Time',
          '+5:30': 'India Standard Time', '+05:30': 'India Standard Time',
          '+6': 'Bangladesh Standard Time', '+06': 'Bangladesh Standard Time',
          '+8': 'China Standard Time', '+08': 'China Standard Time',
          '+9': 'Japan Standard Time', '+09': 'Japan Standard Time',
          '+10': 'Australian Eastern Standard Time', '+11': 'Australian Eastern Daylight Time',
          '-5': 'Eastern Time', '-05': 'Eastern Time',
          '-6': 'Central Time', '-06': 'Central Time',
          '-7': 'Mountain Time', '-07': 'Mountain Time',
          '-8': 'Pacific Time', '-08': 'Pacific Time',
          '-9': 'Alaska Standard Time', '-09': 'Alaska Standard Time',
          '-10': 'Hawaii Standard Time',
          '+0': 'Greenwich Mean Time', '+00': 'Greenwich Mean Time',
          '+1': 'Central European Time', '+01': 'Central European Time',
          '+2': 'Eastern European Time', '+02': 'Eastern European Time',
          '+3': 'Moscow Standard Time', '+03': 'Moscow Standard Time',
          '+4': 'Gulf Standard Time', '+04': 'Gulf Standard Time',
        };
        
        return offsetToTz[offsetKey] || offsetToTz[offsetKeyAlt] || `GMT${sign}${hours}`;
      }
    }
    
    // Final fallback: format timezone name nicely
    if (timezoneName) {
      const parts = timezoneName.split('/');
      if (parts.length > 1) {
        // Convert "America/New_York" to "New York Time" or similar
        const region = parts[0];
        const city = parts[1].replace(/_/g, ' ');
        
        // Special cases
        if (region === 'America') {
          if (city.includes('New York') || city.includes('Toronto')) return 'Eastern Time';
          if (city.includes('Chicago')) return 'Central Time';
          if (city.includes('Denver')) return 'Mountain Time';
          if (city.includes('Los Angeles')) return 'Pacific Time';
        }
        
        return city + ' Time';
      }
      return timezoneName;
    }
    
    return '';
  }
  
  // Format date and time using the event's actual timezone
  let dateTimeStr = '';
  if (startDate) {
    const dayNames = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
    const monthNames = ['January', 'February', 'March', 'April', 'May', 'June', 'July', 'August', 'September', 'October', 'November', 'December'];
    
    // Use event's timezone if available
    let timezoneToUse = eventTimezone;
    
    // Format time using the event's timezone
    const timeOptions = { 
      hour: 'numeric', 
      minute: '2-digit', 
      hour12: true
    };
    
    // Add timezone if available
    if (timezoneToUse) {
      timeOptions.timeZone = timezoneToUse;
    }
    
    // Format time without timezone (we'll add it separately)
    const timeOptionsNoTz = { 
      hour: 'numeric', 
      minute: '2-digit', 
      hour12: true
    };
    if (timezoneToUse) {
      timeOptionsNoTz.timeZone = timezoneToUse;
    }
    
    const startTimeOnly = startDate.toLocaleTimeString('en-US', timeOptionsNoTz);
    const endTimeOnly = endDate ? endDate.toLocaleTimeString('en-US', timeOptionsNoTz) : '';
    
    // Get timezone full name (e.g., "Eastern Time" instead of "ET")
    let timezoneName = getTimezoneFullName(timezoneToUse, startDate);
    
    // If still no name, try to get it from the formatted time string
    if (!timezoneName) {
      try {
        const timeWithTz = startDate.toLocaleTimeString('en-US', { 
          hour: 'numeric', 
          minute: '2-digit', 
          hour12: true,
          timeZoneName: 'long',
          timeZone: timezoneToUse || undefined
        });
        // Extract timezone from formatted string (e.g., "10:30 PM Eastern Time" -> "Eastern Time")
        const parts = timeWithTz.split(' ');
        // Find timezone name (usually last 2-3 words)
        if (parts.length >= 3) {
          // Try to extract timezone name (last 2-3 words)
          const possibleTz = parts.slice(-2).join(' '); // Last 2 words
          if (possibleTz.includes('Time') || possibleTz.includes('GMT')) {
            timezoneName = possibleTz;
          } else if (parts.length >= 3) {
            const possibleTz3 = parts.slice(-3).join(' '); // Last 3 words
            if (possibleTz3.includes('Time')) {
              timezoneName = possibleTz3;
            }
          }
        }
      } catch (e) {
        console.error('Error extracting timezone from string:', e);
      }
    }
    
    // Get date components
    const dateOptions = { 
      year: 'numeric', 
      month: 'long', 
      day: 'numeric', 
      weekday: 'long' 
    };
    if (timezoneToUse) {
      dateOptions.timeZone = timezoneToUse;
    }
    
    const startDateStr = startDate.toLocaleDateString('en-US', dateOptions);
    
    // Parse the formatted date string to extract components
    const dateParts = startDateStr.split(', ');
    const dayName = dateParts[0];
    const monthDay = dateParts[1].split(' ');
    const monthName = monthDay[0];
    const day = parseInt(monthDay[1]);
    
    // Format: "Saturday, December 6th @ 10:30 PM - 11:30 PM Eastern Time" (using event's timezone)
    // Always show full timezone name
    dateTimeStr = `${dayName}, ${monthName} ${day}${getOrdinalSuffix(day)} @ ${startTimeOnly}${endTimeOnly ? ' - ' + endTimeOnly : ''} ${timezoneName || ''}`.trim();
  }
  
  // Set title and subtitle - format title in uppercase
  const eventTitle = (event.summary || 'Untitled Event').toUpperCase();
  titleEl.textContent = eventTitle;
  subtitleEl.innerHTML = '<span>ACQUISITION ACE ACADEMY</span>';
  
  // Add "WITH [HOST]" if host is available
  const host = '{{ host }}' || '';
  if (host) {
    subtitleEl.innerHTML += ` <span style="opacity: 0.9;">WITH ${host.toUpperCase()}</span>`;
  }
  
  // Build body content
  let bodyHtml = '';
  
  // Date and Time
  if (dateTimeStr) {
    bodyHtml += `
      <div class="event-detail-item">
        <div class="event-detail-icon">üìÖ</div>
        <div class="event-detail-content">
          <div class="event-detail-label">Date & Time</div>
          <div class="event-detail-value">${escapeHtml(dateTimeStr)}</div>
        </div>
      </div>
    `;
  }
  
  // Meeting Link (Google Meet or Location)
  if (event.hangoutLink) {
    bodyHtml += `
      <div class="event-detail-item">
        <div class="event-detail-icon">üìπ</div>
        <div class="event-detail-content">
          <div class="event-detail-label">Meeting Link</div>
          <div class="event-detail-value">
            <a href="${escapeHtml(event.hangoutLink)}" target="_blank">${escapeHtml(event.hangoutLink)}</a>
          </div>
        </div>
      </div>
    `;
  } else if (event.location) {
    bodyHtml += `
      <div class="event-detail-item">
        <div class="event-detail-icon">üìç</div>
        <div class="event-detail-content">
          <div class="event-detail-label">Location</div>
          <div class="event-detail-value">${escapeHtml(event.location)}</div>
        </div>
      </div>
    `;
  }
  
  // Description
  if (event.description) {
    bodyHtml += `
      <div class="event-detail-item">
        <div class="event-detail-icon">üìù</div>
        <div class="event-detail-content">
          <div class="event-detail-label">Description</div>
          <div class="event-detail-value event-description">${escapeHtml(event.description)}</div>
        </div>
      </div>
    `;
  }
  
  // Organizer
  if (event.organizer && event.organizer.email) {
    bodyHtml += `
      <div class="event-detail-item">
        <div class="event-detail-icon">üë§</div>
        <div class="event-detail-content">
          <div class="event-detail-label">Organizer</div>
          <div class="event-detail-value">${escapeHtml(event.organizer.displayName || event.organizer.email)}</div>
        </div>
      </div>
    `;
  }
  
  // Attendees
  if (event.attendees && event.attendees.length > 0) {
    bodyHtml += `
      <div class="event-detail-item">
        <div class="event-detail-icon">üë•</div>
        <div class="event-detail-content">
          <div class="event-detail-label">Attendees</div>
          <div class="event-attendees-list">
            ${event.attendees.map(att => {
              const email = att.email || 'Unknown';
              const isOrganizer = att.organizer ? 'organizer' : '';
              return `<span class="event-attendee-badge ${isOrganizer}">${escapeHtml(email)}${att.organizer ? ' (Organizer)' : ''}</span>`;
            }).join('')}
          </div>
        </div>
      </div>
    `;
  }
  
  bodyEl.innerHTML = bodyHtml;
  
  // Build footer with buttons
  const calendarId = '{{ calendar_id }}' || 'primary';
  let footerHtml = '';
  if (event.hangoutLink) {
    footerHtml += `<a href="${escapeHtml(event.hangoutLink)}" target="_blank" class="btn-join-meeting" style="opacity: 0.5; pointer-events: none; cursor: not-allowed;">üìπ Join Meeting</a>`;
  }
  // Add to Calendar button - store event data and calendar_id, use onclick to pass button element
  const eventJson = JSON.stringify(event).replace(/"/g, '&quot;').replace(/'/g, '&#39;');
  footerHtml += `<div id="registrationButtonContainer"></div>`;
  footerHtml += `<div id="registrationError" class="mt-2" style="font-size: 0.9rem; color: #d32f2f; display: none; min-height: 20px;"></div>`;
  footerHtml += `<div id="registrationFullMessage" class="mt-2" style="font-size: 0.95rem; color: #d32f2f; font-weight: 600; display: none;">‚ö†Ô∏è No slots available. Maximum 10 registrations reached.</div>`;
  footerEl.innerHTML = footerHtml;
  
  // Check registration count and update button state (hide button and show message when full)
  checkRegistrationStatus(event.id, eventJson, calendarId);
  
  // Clear any previous error messages when opening modal
  const errorEl = document.getElementById('registrationError');
  if (errorEl) {
    errorEl.style.display = 'none';
    errorEl.innerHTML = '';
  }
  
  // Show modal
  modalEl.classList.add('show');
  
  // Close on background click
  modalEl.addEventListener('click', function(e) {
    if (e.target === modalEl) {
      closeEventModal();
    }
  });
}

function closeEventModal() {
  const modal = document.getElementById('eventDetailModal');
  if (modal) {
    modal.classList.remove('show');
  }
}

// Handler function for Add to Calendar button - uses email from URL parameter
async function handleAddToCalendar(button) {
  const eventJson = button.getAttribute('data-event-data');
  const calendarId = button.getAttribute('data-calendar-id');
  
  if (!eventJson) {
    alert('Event data not found');
    return;
  }
  
  try {
    const eventData = JSON.parse(eventJson.replace(/&quot;/g, '"').replace(/&#39;/g, "'"));
    
    // Check if event is full before proceeding - don't call API if full
    const statusResponse = await fetch(`/api/calendar/events/${encodeURIComponent(eventData.id)}/registration-count`);
    const statusData = await statusResponse.json();
    
    if (statusData.success && statusData.is_full) {
      // Event is full - hide button and show message, don't call API
      const buttonContainer = document.getElementById('registrationButtonContainer');
      const fullMessageEl = document.getElementById('registrationFullMessage');
      
      if (buttonContainer) {
        buttonContainer.style.display = 'none';
      }
      if (fullMessageEl) {
        fullMessageEl.style.display = 'block';
      }
      return; // Don't call API
    }
    
    // Get email from URL parameter or template variable
    const urlParams = new URLSearchParams(window.location.search);
    const userEmail = urlParams.get('email') || '{{ user_email }}' || '';
    
    if (!userEmail) {
      alert('Email address is required. Please go back to the form and enter your email first.');
      return;
    }
    
    // Validate email format
    const emailPattern = /^[a-zA-Z0-9._%+-]+@[a-zA-Z0-9.-]+\.[a-zA-Z]{2,}$/;
    if (!emailPattern.test(userEmail)) {
      alert('Invalid email address. Please go back to the form and enter a valid email.');
      return;
    }
    
    addToCalendar(eventData, calendarId, button, userEmail);
  } catch (error) {
    console.error('Error parsing event data:', error);
    alert('Error loading event data');
  }
}

// Check registration status for an event
async function checkRegistrationStatus(eventId, eventJson, calendarId) {
  try {
    const response = await fetch(`/api/calendar/events/${encodeURIComponent(eventId)}/registration-count`);
    const data = await response.json();
    
    if (data.success) {
      const buttonContainer = document.getElementById('registrationButtonContainer');
      const fullMessageEl = document.getElementById('registrationFullMessage');
      
      if (data.is_full) {
        // Event is full - hide button and show message
        if (buttonContainer) {
          buttonContainer.style.display = 'none';
        }
        if (fullMessageEl) {
          fullMessageEl.style.display = 'block';
        }
      } else {
        // Event has slots - show button and hide message
        if (buttonContainer) {
          buttonContainer.innerHTML = `<button class="btn-add-calendar" data-event-data='${eventJson}' data-calendar-id="${calendarId}" onclick="handleAddToCalendar(this); return false;">üìÖ Add to Calendar <span style="font-size: 0.8em;">‚Üì</span></button>`;
          buttonContainer.style.display = 'block';
        }
        if (fullMessageEl) {
          fullMessageEl.style.display = 'none';
        }
      }
    }
  } catch (error) {
    console.error('Error checking registration status:', error);
    // On error, show button anyway
    const buttonContainer = document.getElementById('registrationButtonContainer');
    if (buttonContainer && eventJson && calendarId) {
      buttonContainer.innerHTML = `<button class="btn-add-calendar" data-event-data='${eventJson}' data-calendar-id="${calendarId}" onclick="handleAddToCalendar(this); return false;">üìÖ Add to Calendar <span style="font-size: 0.8em;">‚Üì</span></button>`;
      buttonContainer.style.display = 'block';
    }
  }
}

async function addToCalendar(eventData, calendarId, button, userEmail) {
  if (!button) {
    console.error('Button element not provided');
    return;
  }
  
  const originalText = button.innerHTML;
  
  try {
    // Disable button and show loading state
    button.disabled = true;
    button.innerHTML = '<span class="spinner-border spinner-border-sm me-2" style="width: 1rem; height: 1rem; border-width: 0.15rem;"></span>Adding...';
    
    // Prepare request payload to add user as attendee
    const eventPayload = {
      event_id: eventData.id,
      user_email: userEmail,
      calendar_id: calendarId || '{{ calendar_id }}' || 'primary'
    };
    
    // Call API to add user as attendee to existing event
    const response = await fetch('/api/calendar/events/add-attendee', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify(eventPayload)
    });
    
    const data = await response.json();
    
    if (data.success) {
      // Show success message
      button.innerHTML = '‚úì Added!';
      button.style.background = 'linear-gradient(135deg, rgba(25, 135, 84, 0.9) 0%, rgba(40, 167, 69, 0.9) 100%)';
      
      // Update button state if event is full - hide button and show message
      if (data.registration_count !== undefined && data.registration_count >= 10) {
        const buttonContainer = document.getElementById('registrationButtonContainer');
        const fullMessageEl = document.getElementById('registrationFullMessage');
        
        if (buttonContainer) {
          buttonContainer.style.display = 'none';
        }
        if (fullMessageEl) {
          fullMessageEl.style.display = 'block';
        }
      }
      
      // Optionally open the event in Google Calendar
      if (data.event && data.event.htmlLink) {
        setTimeout(() => {
          window.open(data.event.htmlLink, '_blank');
        }, 500);
      }
      
      // Reset button after 3 seconds (if not full)
      if (data.registration_count < 10) {
        setTimeout(() => {
          button.disabled = false;
          button.innerHTML = originalText;
          button.style.background = '';
        }, 3000);
      }
    } else {
      // Handle errors - show error message in UI
      const errorEl = document.getElementById('registrationError');
      
      if (data.full) {
        // Event is full - hide button and show message
        const buttonContainer = document.getElementById('registrationButtonContainer');
        const fullMessageEl = document.getElementById('registrationFullMessage');
        
        if (buttonContainer) {
          buttonContainer.style.display = 'none';
        }
        if (fullMessageEl) {
          fullMessageEl.style.display = 'block';
        }
      } else if (data.already_registered) {
        // User already registered
        button.innerHTML = '‚úì Already Registered';
        button.style.background = 'linear-gradient(135deg, rgba(25, 135, 84, 0.9) 0%, rgba(40, 167, 69, 0.9) 100%)';
        button.disabled = true;
        button.style.opacity = '0.7';
        button.style.cursor = 'not-allowed';
        button.style.pointerEvents = 'none';
        
        if (errorEl) {
          errorEl.style.display = 'block';
          errorEl.innerHTML = '<span style="color: #1976d2; font-weight: 500;">‚ÑπÔ∏è ' + escapeHtml(data.error || 'You are already registered for this event') + '</span>';
        }
      } else {
        // Other errors
        if (errorEl) {
          errorEl.style.display = 'block';
          errorEl.innerHTML = '<span style="color: #d32f2f; font-weight: 600;">‚ö†Ô∏è ' + escapeHtml(data.error || 'Failed to add as attendee') + '</span>';
        }
        
        // Reset button
        button.disabled = false;
        button.innerHTML = originalText;
        
        if (data.event_html_link) {
          const useLink = confirm(data.error + '\n\nWould you like to open the event in Google Calendar to add yourself manually?');
          if (useLink) {
            window.open(data.event_html_link, '_blank');
          }
        }
      }
    }
  } catch (error) {
    console.error('Error adding attendee to event:', error);
    button.disabled = false;
    button.innerHTML = originalText;
    
    // Show error in UI
    const errorEl = document.getElementById('registrationError');
    if (errorEl) {
      errorEl.style.display = 'block';
      errorEl.innerHTML = '<span style="color: #d32f2f; font-weight: 600;">‚ö†Ô∏è ' + escapeHtml(error.message || 'Failed to add as attendee') + '</span>';
    }
  }
}

function getOrdinalSuffix(day) {
  if (day > 3 && day < 21) return 'th';
  switch (day % 10) {
    case 1: return 'st';
    case 2: return 'nd';
    case 3: return 'rd';
    default: return 'th';
  }
}

// Fetch and load calendar events
async function loadCalendarEvents() {
  const loaderEl = document.getElementById('calendarLoader');
  const calendarContentEl = document.getElementById('calendarContent');
  
  try {
    // Show loader (full screen with fade)
    if (loaderEl) loaderEl.classList.add('show');
    if (calendarContentEl) calendarContentEl.classList.remove('loaded');
    
    const calendarId = '{{ calendar_id }}' || 'primary';
    const response = await fetch(`/api/calendar/events?calendar_id=${encodeURIComponent(calendarId)}`);
    const data = await response.json();
    
    if (data.success && data.events && data.events.length > 0) {
      // Filter future events
      const now = new Date();
      const futureEvents = data.events.filter(event => {
        const startTime = typeof event.start === 'string' ? event.start : (event.start?.dateTime || event.start?.date);
        return startTime && new Date(startTime) >= now;
      });
      
      // Update calendar with events
      if (window.calendarInstance) {
        window.calendarInstance.setEvents(futureEvents);
      }
    }
    
    // Hide loader and show content with fade
    setTimeout(() => {
      if (loaderEl) loaderEl.classList.remove('show');
      if (calendarContentEl) calendarContentEl.classList.add('loaded');
    }, 300); // Small delay for smooth transition
  } catch (error) {
    console.error('Error loading calendar events:', error);
    // Hide loader even on error
    if (loaderEl) loaderEl.classList.remove('show');
    if (calendarContentEl) {
      calendarContentEl.classList.add('loaded');
      calendarContentEl.innerHTML = `
        <div class="alert alert-danger m-3">
          <strong>Error loading events:</strong> ${error.message || 'Failed to load calendar events. Please try again later.'}
        </div>
      `;
    }
  }
}

// Initialize calendar when page loads
document.addEventListener('DOMContentLoaded', function() {
  const formType = '{{ form_type }}';
  const host = '{{ host }}';
  
  window.calendarInstance = new CustomCalendar('customCalendarContainer', {
    formType: formType,
    host: host,
    events: [],
    onDateSelect: (date, events) => {
      const eventsContainer = document.getElementById('calendarEvents');
      const eventsList = document.getElementById('eventsList');
      
      if (events.length > 0) {
        eventsList.innerHTML = events.map(event => {
          const startTime = typeof event.start === 'string' ? event.start : (event.start?.dateTime || event.start?.date);
          const eventTime = startTime ? new Date(startTime).toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' }) : 'All day';
          return `
            <div class="event-item" onclick="const eventData = window.calendarInstance.events.find(e => e.id === '${event.id}'); if(eventData) showEventDetails(eventData);">
              <div class="event-time">${escapeHtml(eventTime)}</div>
              <div class="event-title">${escapeHtml(event.summary || 'Untitled Event')}</div>
            </div>
          `;
        }).join('');
        eventsContainer.style.display = 'block';
      } else {
        eventsList.innerHTML = '<div class="no-events">No events scheduled for this date.</div>';
        eventsContainer.style.display = 'block';
      }
    }
  });
  
  // Load events from Google Calendar
  loadCalendarEvents();
});
</script>
{% endblock %}

{% block content %}

  <div class="container py-2">
    <div class="row justify-content-center">
      <div class="col-lg-12">
        <div class="card shadow-sm border-0">
          <div class="card-header bg-white border-0 pt-4 pb-3">
            <h2 class="text-center mb-2">Schedule a Live Call</h2>
            <p class="text-center text-muted mb-0">{{ form_type }}{% if host %} - {{ host }}{% endif %}</p>
          </div>
          
          <div class="card-body p-4 p-md-5">
            <div class="mb-3">
              <a href="javascript:history.back()" class="btn btn-outline-secondary rounded-pill">‚Üê Back</a>
            </div>
            
            <!-- Full Screen Loader -->
            <div id="calendarLoader" class="calendar-loader show">
              <div class="spinner-border" role="status">
                <span class="visually-hidden">Loading events...</span>
              </div>
              <div class="calendar-loader-text">Loading calendar events...</div>
            </div>
            
            <!-- Calendar Content -->
            <div id="calendarContent" class="calendar-content">
              <div id="customCalendarContainer" class="custom-calendar"></div>
              <div id="calendarEvents" class="calendar-events" style="display: none;">
                <h6 class="mb-3">Events for selected date:</h6>
                <div id="eventsList"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

{% endblock %}
